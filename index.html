<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#ffffff">
    <title>薯片机 - 免费 AI 聊天</title>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, "PingFang SC", "Microsoft YaHei", "Helvetica Neue", sans-serif;
            -webkit-user-select: none;
            user-select: none;
            -webkit-touch-callout: none;
            -webkit-tap-highlight-color: transparent;
            tap-highlight-color: transparent;
        }
        
        html, body {
            width: 100%;
            height: 100%;
            background-color: #ffffff;
            color: #000000;
            overflow: hidden;
        }
        
        #app-container {
            width: 100vw;
            height: 100vh;
            height: 100dvh;
            display: flex;
            flex-direction: column;
            position: relative;
            overflow: hidden;
        }

        .icon-svg {
            width: 100%;
            height: 100%;
            stroke: #333;
            stroke-width: 1.8;
            fill: none;
            stroke-linecap: round;
            stroke-linejoin: round;
        }

        /* 顶部导航栏 */
        .top-nav {
            height: 50px;
            min-height: 50px;
            width: 100%;
            background-color: #ffffff;
            border-bottom: 1px solid #f0f0f0;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 15px;
            position: relative;
            z-index: 100;
        }
        
        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            padding: 5px;
            border-radius: 8px;
            will-change: transform;
            transform: translateZ(0);
        }
        .user-info:active {
            background-color: #f5f5f5;
        }
        
        .user-avatar {
            width: 35px;
            height: 35px;
            min-width: 35px;
            min-height: 35px;
            border-radius: 50%;
            background-color: #f5f5f5;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 14px;
            color: #333;
            overflow: hidden;
            flex-shrink: 0;
        }
        
        .user-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .user-name {
            font-size: 16px;
            font-weight: 500;
            color: #000;
        }
        
        .add-btn {
            width: 35px;
            height: 35px;
            min-width: 35px;
            min-height: 35px;
            border-radius: 50%;
            background-color: #f5f5f5;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            padding: 8px;
            flex-shrink: 0;
        }
        .add-btn:active {
            background-color: #e8e8e8;
        }

        /* 侧边功能栏 */
        .side-menu {
            position: fixed;
            top: 0;
            left: 0;
            width: 80%;
            max-width: 320px;
            height: 100vh;
            height: 100dvh;
            background-color: #ffffff;
            z-index: 300;
            transform: translateX(-100%);
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            will-change: transform;
            display: flex;
            flex-direction: column;
            box-shadow: 2px 0 10px rgba(0,0,0,0.1);
        }
        .side-menu.open {
            transform: translateX(0);
        }
        
        /* 用户名片区域 - 背景图全覆盖到钱包上方 */
        .card-info {
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 0;
            cursor: pointer;
            overflow: hidden;
        }
        
        .card-bg {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            background-size: cover;
            background-position: center;
            z-index: 0;
        }
        
        .card-content {
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 40px 20px 25px;
            position: relative;
            z-index: 1;
        }
        
        .card-avatar {
            width: 70px;
            height: 70px;
            min-width: 70px;
            min-height: 70px;
            border-radius: 50%;
            background-color: #e8e8e8;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            font-weight: bold;
            color: #666;
            overflow: hidden;
            flex-shrink: 0;
            border: 3px solid #fff;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        }
        
        .card-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .card-name {
            font-size: 18px;
            font-weight: bold;
            color: #fff;
            margin-bottom: 5px;
            text-shadow: 0 1px 3px rgba(0,0,0,0.3);
        }
        
        .card-signature {
            font-size: 12px;
            color: rgba(255,255,255,0.9);
            padding: 0 20px;
            text-align: center;
            max-width: 100%;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            text-shadow: 0 1px 2px rgba(0,0,0,0.2);
        }
        
        .menu-list {
            flex: 1;
            padding: 10px 0;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }
        
        .menu-item {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 14px 20px;
            cursor: pointer;
        }
        .menu-item:active {
            background-color: #f5f5f5;
        }
        
        .menu-icon {
            width: 22px;
            height: 22px;
            min-width: 22px;
            min-height: 22px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }
        
        .menu-text {
            font-size: 15px;
            color: #333;
        }
        
        .menu-divider {
            height: 1px;
            background-color: #f0f0f0;
            margin: 10px 20px;
        }

        /* 遮罩层 */
        .mask {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            height: 100dvh;
            background-color: rgba(0, 0, 0, 0.4);
            z-index: 250;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        .mask.show {
            opacity: 1;
            visibility: visible;
        }

        /* 主内容区域 */
        .main-content {
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
            display: none;
            -webkit-overflow-scrolling: touch;
        }
        .main-content.active {
            display: flex;
            flex-direction: column;
        }
        
        .search-bar {
            padding: 10px 15px;
            background-color: #fff;
            flex-shrink: 0;
        }
        .search-input {
            width: 100%;
            height: 36px;
            background-color: #f5f5f5;
            border: none;
            border-radius: 18px;
            padding: 0 15px 0 40px;
            font-size: 14px;
            color: #333;
            outline: none;
        }
        .search-input::placeholder {
            color: #999;
        }
        .search-wrapper {
            position: relative;
        }
        .search-icon {
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            width: 18px;
            height: 18px;
        }
        
        /* 消息页面 */
        .msg-page {
            padding: 0;
        }
        
        .msg-list {
            flex: 1;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }
        
        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 60px 20px;
            color: #999;
        }
        .empty-icon {
            width: 80px;
            height: 80px;
            margin-bottom: 15px;
            opacity: 0.5;
        }
        .empty-text {
            font-size: 14px;
            text-align: center;
            line-height: 1.6;
        }
        
        .msg-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 15px;
            background-color: #fff;
            border-bottom: 1px solid #f5f5f5;
            cursor: pointer;
        }
        .msg-item:active {
            background-color: #f5f5f5;
        }
        
        .msg-avatar {
            width: 48px;
            height: 48px;
            min-width: 48px;
            min-height: 48px;
            border-radius: 50%;
            background-color: #f0f0f0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            color: #666;
            position: relative;
            overflow: hidden;
            flex-shrink: 0;
        }
        
        .msg-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .msg-badge {
            position: absolute;
            top: -2px;
            right: -2px;
            min-width: 18px;
            height: 18px;
            background-color: #ff4d4f;
            border-radius: 9px;
            font-size: 11px;
            color: #fff;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0 5px;
        }
        
        .msg-content {
            flex: 1;
            min-width: 0;
        }
        
        .msg-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 4px;
        }
        
        .msg-title {
            font-size: 16px;
            font-weight: 500;
            color: #000;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .msg-time {
            font-size: 11px;
            color: #999;
            white-space: nowrap;
            flex-shrink: 0;
            margin-left: 10px;
        }
        
        .msg-desc {
            font-size: 13px;
            color: #999;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* 好友页面 */
        .friend-page {
            padding: 0;
        }
        
        .friend-content {
            flex: 1;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }
        
        .friend-group {
            margin-bottom: 0;
        }
        
        .group-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 15px;
            background-color: #fafafa;
            border-bottom: 1px solid #f0f0f0;
            cursor: pointer;
        }
        
        .group-title-left {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .group-arrow {
            width: 8px;
            height: 8px;
            border-right: 2px solid #666;
            border-bottom: 2px solid #666;
            transform: rotate(45deg);
            transition: transform 0.2s ease;
        }
        .group-header.collapsed .group-arrow {
            transform: rotate(-45deg);
        }
        
        .group-title {
            font-size: 14px;
            font-weight: 500;
            color: #333;
        }
        
        .group-count {
            font-size: 12px;
            color: #999;
        }
        
        .group-edit {
            font-size: 12px;
            color: #666;
            padding: 5px 10px;
        }
        
        .friend-list {
            display: none;
            flex-direction: column;
        }
        .friend-list.show {
            display: flex;
        }
        
        .friend-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px 15px 10px 35px;
            background-color: #fff;
            border-bottom: 1px solid #f5f5f5;
            cursor: pointer;
        }
        .friend-item:active {
            background-color: #f5f5f5;
        }
        
        .friend-avatar {
            width: 42px;
            height: 42px;
            min-width: 42px;
            min-height: 42px;
            border-radius: 50%;
            background-color: #f0f0f0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            color: #666;
            overflow: hidden;
            flex-shrink: 0;
        }
        
        .friend-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .friend-info {
            flex: 1;
            min-width: 0;
        }
        
        .friend-name {
            font-size: 15px;
            color: #000;
            margin-bottom: 2px;
        }
        
        .friend-status {
            font-size: 12px;
            color: #999;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* 动态页面 - 重新设计布局 */
        .dynamic-page {
            padding: 0;
            background-color: #f5f5f5;
        }
        
        .dynamic-content {
            flex: 1;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            padding: 12px;
        }
        
        /* 功能分组 */
        .func-section {
            background-color: #fff;
            border-radius: 12px;
            margin-bottom: 12px;
            overflow: hidden;
        }
        
        .func-section-title {
            font-size: 13px;
            color: #999;
            padding: 12px 15px 8px;
            font-weight: 500;
        }
        
        .func-row {
            display: flex;
            align-items: center;
            padding: 14px 15px;
            cursor: pointer;
            border-bottom: 1px solid #f5f5f5;
        }
        .func-row:last-child {
            border-bottom: none;
        }
        .func-row:active {
            background-color: #f9f9f9;
        }
        
        .func-row-icon {
            width: 40px;
            height: 40px;
            min-width: 40px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 12px;
            flex-shrink: 0;
        }
        
        .func-row-icon svg {
            width: 22px;
            height: 22px;
        }
        
        .func-row-icon.blue { background-color: #e8f4fd; }
        .func-row-icon.blue svg { stroke: #1890ff; }
        
        .func-row-icon.orange { background-color: #fff7e6; }
        .func-row-icon.orange svg { stroke: #fa8c16; }
        
        .func-row-icon.green { background-color: #f6ffed; }
        .func-row-icon.green svg { stroke: #52c41a; }
        
        .func-row-icon.purple { background-color: #f9f0ff; }
        .func-row-icon.purple svg { stroke: #722ed1; }
        
        .func-row-icon.red { background-color: #fff1f0; }
        .func-row-icon.red svg { stroke: #f5222d; }
        
        .func-row-icon.cyan { background-color: #e6fffb; }
        .func-row-icon.cyan svg { stroke: #13c2c2; }
        
        .func-row-icon.gray { background-color: #f5f5f5; }
        .func-row-icon.gray svg { stroke: #666; }
        
        .func-row-content {
            flex: 1;
            min-width: 0;
        }
        
        .func-row-name {
            font-size: 16px;
            color: #333;
            font-weight: 400;
        }
        
        .func-row-arrow {
            width: 8px;
            height: 8px;
            border-top: 2px solid #ccc;
            border-right: 2px solid #ccc;
            transform: rotate(45deg);
            flex-shrink: 0;
            margin-left: 10px;
        }

        .more-func-item {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 16px 15px;
            background-color: #fff;
            border-radius: 12px;
            cursor: pointer;
        }
        .more-func-item:active {
            background-color: #f5f5f5;
        }
        .more-func-text {
            font-size: 14px;
            color: #666;
        }

        /* 子页面容器 */
        .sub-page {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100vh;
            height: 100dvh;
            background-color: #fff;
            z-index: 200;
            transform: translateX(100%);
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            will-change: transform;
            display: flex;
            flex-direction: column;
        }
        .sub-page.open {
            transform: translateX(0);
        }
        
        .sub-nav {
            height: 50px;
            min-height: 50px;
            display: flex;
            align-items: center;
            padding: 0 15px;
            background-color: #fff;
            border-bottom: 1px solid #f0f0f0;
            flex-shrink: 0;
        }
        
        .back-btn {
            display: flex;
            align-items: center;
            gap: 5px;
            padding: 8px 0;
            cursor: pointer;
            font-size: 15px;
            color: #333;
        }
        .back-arrow {
            width: 10px;
            height: 10px;
            border-left: 2px solid #333;
            border-bottom: 2px solid #333;
            transform: rotate(45deg);
        }
        
        .sub-title {
            flex: 1;
            text-align: center;
            font-size: 17px;
            font-weight: 500;
            color: #000;
            margin-right: 60px;
        }
        
        .sub-content {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
            -webkit-overflow-scrolling: touch;
        }
        
        .placeholder-text {
            text-align: center;
            color: #999;
            padding: 50px 20px;
            font-size: 14px;
            line-height: 1.8;
        }

        /* 底部标签栏 */
        .tab-bar {
            height: 55px;
            min-height: 55px;
            width: 100%;
            background-color: #ffffff;
            border-top: 1px solid #f0f0f0;
            display: flex;
            justify-content: space-around;
            align-items: center;
            padding-bottom: env(safe-area-inset-bottom);
            flex-shrink: 0;
        }
        
        .tab-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 3px;
            cursor: pointer;
            padding: 5px 20px;
            opacity: 0.5;
            transition: opacity 0.2s ease;
        }
        .tab-item.active {
            opacity: 1;
        }
        
        .tab-icon {
            width: 24px;
            height: 24px;
            min-width: 24px;
            min-height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }
        
        .tab-text {
            font-size: 11px;
            color: #333;
        }

        /* 添加弹窗 - 更圆润 */
        .add-popup {
            position: fixed;
            top: 55px;
            right: 15px;
            background-color: #fff;
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            z-index: 150;
            opacity: 0;
            visibility: hidden;
            transform: scale(0.9) translateY(-10px);
            transform-origin: top right;
            transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
            min-width: 180px;
            overflow: hidden;
        }
        .add-popup.show {
            opacity: 1;
            visibility: visible;
            transform: scale(1) translateY(0);
        }
        
        .popup-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 14px 18px;
            cursor: pointer;
            white-space: nowrap;
            transition: background-color 0.15s ease;
        }
        .popup-item:active {
            background-color: #f5f5f5;
        }
        
        .popup-icon {
            width: 22px;
            height: 22px;
            min-width: 22px;
            min-height: 22px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }
        
        .popup-text {
            font-size: 15px;
            color: #333;
        }
        
        .popup-divider {
            height: 1px;
            background-color: #f0f0f0;
            margin: 0 15px;
        }

        /* 添加好友/群聊页面 */
        .add-friend-page {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100vh;
            height: 100dvh;
            background-color: #f5f5f5;
            z-index: 200;
            transform: translateX(100%);
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            will-change: transform;
            display: flex;
            flex-direction: column;
        }
        .add-friend-page.open {
            transform: translateX(0);
        }
        
        .add-page-content {
            flex: 1;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }
        
        .add-section {
            background-color: #fff;
            border-radius: 16px;
            margin: 15px;
            overflow: hidden;
        }
        
        .add-section-header {
            font-size: 13px;
            color: #999;
            padding: 15px 15px 10px;
        }
        
        .add-input-group {
            padding: 0 15px 15px;
        }
        
        .add-input-label {
            font-size: 14px;
            color: #666;
            margin-bottom: 8px;
            display: block;
        }
        
        .add-input {
            width: 100%;
            height: 44px;
            border: 1px solid #e0e0e0;
            border-radius: 12px;
            padding: 0 15px;
            font-size: 15px;
            outline: none;
            transition: border-color 0.2s ease;
            background-color: #fff;
            -webkit-user-select: text;
            user-select: text;
        }
        .add-input:focus {
            border-color: #333;
        }
        
        .add-textarea {
            width: 100%;
            min-height: 100px;
            border: 1px solid #e0e0e0;
            border-radius: 12px;
            padding: 12px 15px;
            font-size: 15px;
            outline: none;
            resize: none;
            transition: border-color 0.2s ease;
            background-color: #fff;
            -webkit-user-select: text;
            user-select: text;
            line-height: 1.5;
        }
        .add-textarea:focus {
            border-color: #333;
        }
        
        .add-btn-group {
            display: flex;
            gap: 12px;
            padding: 15px;
            background-color: #fff;
            border-radius: 16px;
            margin: 0 15px 15px;
        }
        
        .add-submit-btn {
            flex: 1;
            height: 44px;
            background-color: #000;
            color: #fff;
            border: none;
            border-radius: 22px;
            font-size: 15px;
            font-weight: 500;
            cursor: pointer;
            transition: opacity 0.2s ease;
        }
        .add-submit-btn:active {
            opacity: 0.8;
        }
        
        .add-cancel-btn {
            flex: 1;
            height: 44px;
            background-color: #f5f5f5;
            color: #333;
            border: none;
            border-radius: 22px;
            font-size: 15px;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }
        .add-cancel-btn:active {
            background-color: #e8e8e8;
        }
        
        /* 导入角色卡区域 */
        .import-section {
            background-color: #fff;
            border-radius: 16px;
            margin: 15px;
            padding: 15px;
        }
        
        .import-title {
            font-size: 15px;
            font-weight: 500;
            color: #333;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .import-desc {
            font-size: 13px;
            color: #999;
            margin-bottom: 15px;
            line-height: 1.5;
        }
        
        .import-btn {
            width: 100%;
            height: 50px;
            background-color: #fafafa;
            border: 2px dashed #ddd;
            border-radius: 12px;
            font-size: 14px;
            color: #666;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all 0 .2s ease;
        }
        .import-btn:active {
            background-color: #f0f0f0;
            border-color: #ccc;
        }
        
        .import-file-input {
            display: none;
        }
        
        /* 导入预览列表 */
        .import-preview {
            margin-top: 15px;
            max-height: 200px;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }
        
        .import-preview-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px;
            background-color: #f5f5f5;
            border-radius: 8px;
            margin-bottom: 8px;
        }
        
        .import-preview-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .import-preview-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background-color: #e0e0e0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            color: #666;
            overflow: hidden;
        }
        
        .import-preview-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .import-preview-name {
            font-size: 14px;
            color: #333;
        }
        
        .import-preview-remove {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background-color: #ff4d4f;
            color: #fff;
            border: none;
            font-size: 16px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .import-all-btn {
            width: 100%;
            height: 44px;
            background-color: #000;
            color: #fff;
            border: none;
            border-radius: 22px;
            font-size: 15px;
            font-weight: 500;
            cursor: pointer;
            margin-top: 15px;
            display: none;
        }
        .import-all-btn.show {
            display: block;
        }
        .import-all-btn:active {
            opacity: 0.8;
        }

        /* 个性名片编辑页面 - QQ风格 */
        .card-edit-page {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100vh;
            height: 100dvh;
            background-color: #f5f5f5;
            z-index: 400;
            transform: translateX(100%);
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            will-change: transform;
            display: flex;
            flex-direction: column;
        }
        .card-edit-page.open {
            transform: translateX(0);
        }
        
        .card-edit-preview {
            position: relative;
            width: 100%;
            height: 200px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            background-size: cover;
            background-position: center;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        
        .card-edit-preview-avatar {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background-color: #e8e8e8;
            border: 3px solid #fff;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 32px;
            font-weight: bold;
            color: #666;
            overflow: hidden;
            margin-bottom: 10px;
        }
        
        .card-edit-preview-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .card-edit-preview-name {
            font-size: 20px;
            font-weight: bold;
            color: #fff;
            text-shadow: 0 1px 3px rgba(0,0,0,0.3);
        }
        
        .card-edit-preview-sig {
            font-size: 13px;
            color: rgba(255,255,255,0.9);
            margin-top: 5px;
            text-shadow: 0 1px 2px rgba(0,0,0,0.2);
        }
        
        .edit-list {
            flex: 1;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }
        
        .edit-section {
            background-color: #fff;
            margin-top: 10px;
        }
        
        .edit-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 15px;
            background-color: #fff;
            border-bottom: 1px solid #f0f0f0;
            cursor: pointer;
        }
        .edit-item:active {
            background-color: #f5f5f5;
        }
        
        .edit-label {
            font-size: 15px;
            color: #333;
        }
        
        .edit-value {
            display: flex;
            align-items: center;
            gap: 8px;
            color: #999;
            font-size: 14px;
            max-width: 60%;
        }
        
        .edit-value span {
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .edit-arrow {
            width: 8px;
            height: 8px;
            border-top: 2px solid #ccc;
            border-right: 2px solid #ccc;
            transform: rotate(45deg);
            flex-shrink: 0;
        }
        
        .edit-avatar-small {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: #e8e8e8;
            overflow: hidden;
            flex-shrink: 0;
        }
        
        .edit-avatar-small img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        /* 图片选择弹窗 */
        .image-picker-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            z-index: 500;
            display: flex;
            align-items: flex-end;
            justify-content: center;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }
        .image-picker-modal.show {
            opacity: 1;
            visibility: visible;
        }
        
        .image-picker-content {
            width: 100%;
            max-width: 500px;
            background-color: #fff;
            border-radius: 20px 20px 0 0;
            padding: 20px;
            padding-bottom: calc(20px + env(safe-area-inset-bottom));
            transform: translateY(100%);
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .image-picker-modal.show .image-picker-content {
            transform: translateY(0);
        }
        
        .picker-title {
            font-size: 17px;
            font-weight: 600;
            text-align: center;
            margin-bottom: 20px;
            color: #333;
        }
        
        .picker-option {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px;
            background-color: #f5f5f5;
            border-radius: 12px;
            margin-bottom: 10px;
            cursor: pointer;
        }
        .picker-option:active {
            background-color: #e8e8e8;
        }
        
        .picker-option-icon {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            background-color: #fff;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .picker-option-text {
            font-size: 15px;
            color: #333;
        }
        
        .picker-url-input {
            width: 100%;
            height: 44px;
            border: 1px solid #e0e0e0;
            border-radius: 12px;
            padding: 0 15px;
            font-size: 15px;
            outline: none;
            margin-top: 10px;
            -webkit-user-select: text;
            user-select: text;
        }
        .picker-url-input:focus {
            border-color: #333;
        }
        
        .picker-url-confirm {
            width: 100%;
            height: 44px;
            background-color: #000;
            color: #fff;
            border: none;
            border-radius: 22px;
            font-size: 15px;
            margin-top: 10px;
            cursor: pointer;
        }
        .picker-url-confirm:active {
            opacity: 0.8;
        }
        
        .picker-cancel {
            width: 100%;
            height: 44px;
            background-color: transparent;
            color: #999;
            border: none;
            font-size: 15px;
            margin-top: 10px;
            cursor: pointer;
        }

        /* 聊天页面 */
        .chat-page {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100vh;
            height: 100dvh;
            background-color: #f5f5f5;
            z-index: 200;
            transform: translateX(100%);
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            will-change: transform;
            display: flex;
            flex-direction: column;
        }
        .chat-page.open {
            transform: translateX(0);
        }
        
        .chat-nav {
            height: 50px;
            min-height: 50px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 15px;
            background-color: #fff;
            border-bottom: 1px solid #f0f0f0;
            flex-shrink: 0;
        }
        
        .chat-title {
            font-size: 17px;
            font-weight: 500;
            color: #000;
        }
        
        .chat-more {
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }
        .chat-more-dots {
            display: flex;
            gap: 3px;
        }
        .chat-more-dots span {
            width: 4px;
            height: 4px;
            background-color: #333;
            border-radius: 50%;
        }
        
        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
            display: flex;
            flex-direction: column;
            gap: 15px;
            -webkit-overflow-scrolling: touch;
        }
        
        .chat-bubble {
            display: flex;
            gap: 10px;
            max-width: 80%;
        }
        .chat-bubble.received {
            align-self: flex-start;
        }
        .chat-bubble.sent {
            align-self: flex-end;
            flex-direction: row-reverse;
        }
        
        .chat-avatar {
            width: 36px;
            height: 36px;
            min-width: 36px;
            min-height: 36px;
            border-radius: 50%;
            background-color: #e0e0e0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            color: #666;
            overflow: hidden;
            flex-shrink: 0;
        }
        
        .chat-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .chat-text {
            padding: 10px 14px;
            border-radius: 18px;
            font-size: 15px;
            line-height: 1.5;
            word-break: break-word;
            -webkit-user-select: text;
            user-select: text;
        }
        .chat-bubble.received .chat-text {
            background-color: #fff;
            color: #333;
            border-top-left-radius: 4px;
        }
        .chat-bubble.sent .chat-text {
            background-color: #000;
            color: #fff;
            border-top-right-radius: 4px;
        }
        
        .chat-input-area {
            display: flex;
            align-items: flex-end;
            gap: 10px;
            padding: 10px 15px;
            background-color: #fff;
            border-top: 1px solid #f0f0f0;
            padding-bottom: calc(10px + env(safe-area-inset-bottom));
            flex-shrink: 0;
        }
        
        .chat-input {
            flex: 1;
            min-height: 36px;
            max-height: 100px;
            padding: 8px 15px;
            border: 1px solid #e0e0e0;
            border-radius: 18px;
            font-size: 15px;
            resize: none;
            outline: none;
            line-height: 1.4;
            -webkit-user-select: text;
            user-select: text;
        }
        .chat-input:focus {
            border-color: #333;
        }
        
        /* AI回复按钮 */
        .chat-ai-btn {
            width: 36px;
            height: 36px;
            min-width: 36px;
            min-height: 36px;
            background-color: transparent;
            border: 1.5px solid #333;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            transition: all 0.2s ease;
        }
        .chat-ai-btn:active {
            background-color: #f5f5f5;
        }
        .chat-ai-btn svg {
            width: 18px;
            height: 18px;
            stroke: #333;
            fill: none;
        }
        
        .chat-send-btn {
            width: 36px;
            height: 36px;
            min-width: 36px;
            min-height: 36px;
            background-color: #000;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }
        .chat-send-btn:active {
            opacity: 0.8;
        }
        .chat-send-btn svg {
            width: 18px;
            height: 18px;
            stroke: #fff;
            fill: none;
        }

        /* 更多功能设置弹窗 */
        .more-settings-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            z-index: 500;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }
        .more-settings-modal.show {
            opacity: 1;
            visibility: visible;
        }
        
        .more-settings-content {
            width: 90%;
            max-width: 400px;
            max-height: 80vh;
            background-color: #fff;
            border-radius: 20px;
            overflow: hidden;
            transform: scale(0.9);
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .more-settings-modal.show .more-settings-content {
            transform: scale(1);
        }
        
        .more-settings-header {
            padding: 20px;
            border-bottom: 1px solid #f0f0f0;
            text-align: center;
        }
        
        .more-settings-title {
            font-size: 17px;
            font-weight: 600;
            color: #333;
        }
        
        .more-settings-desc {
            font-size: 13px;
            color: #999;
            margin-top: 5px;
        }
        
        .more-settings-list {
            max-height: 50vh;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            padding: 10px 0;
        }
        
        .more-settings-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 20px;
        }
        
        .more-settings-item-left {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .more-settings-item-icon {
            width: 36px;
            height: 36px;
            border-radius: 8px;
            background-color: #f5f5f5;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 8px;
        }
        
        .more-settings-item-name {
            font-size: 15px;
            color: #333;
        }
        
        /* 开关样式 */
        .toggle-switch {
            width: 50px;
            height: 28px;
            background-color: #e0e0e0;
            border-radius: 14px;
            position: relative;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }
        .toggle-switch.active {
            background-color: #000;
        }
        .toggle-switch::after {
            content: '';
            position: absolute;
            width: 24px;
            height: 24px;
            background-color: #fff;
            border-radius: 50%;
            top: 2px;
            left: 2px;
            transition: transform 0.2s ease;
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
        }
        .toggle-switch.active::after {
            transform: translateX(22px);
        }
        
        .more-settings-footer {
            padding: 15px 20px;
            border-top: 1px solid #f0f0f0;
        }
        
        .more-settings-confirm {
            width: 100%;
            height: 44px;
            background-color: #000;
            color: #fff;
            border: none;
            border-radius: 22px;
            font-size: 15px;
            font-weight: 500;
            cursor: pointer;
        }
        .more-settings-confirm:active {
            opacity: 0.8;
        }

        /* API设置页面样式 */
        .api-settings-content {
            padding: 0 !important;
            background-color: #f5f5f5 !important;
        }
        
        .api-section {
            background-color: #fff;
            margin: 12px;
            border-radius: 12px;
            overflow: hidden;
        }
        
        .api-section-title {
            font-size: 13px;
            color: #999;
            padding: 12px 15px 8px;
            font-weight: 500;
        }
        
        .api-item {
            padding: 12px 15px;
            border-bottom: 1px solid #f5f5f5;
        }
        .api-item:last-child {
            border-bottom: none;
        }
        
        .api-item-label {
            font-size: 14px;
            color: #333;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .api-item-hint {
            font-size: 12px;
            color: #999;
        }
        
        .api-input {
            width: 100%;
            height: 40px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 0 12px;
            font-size: 14px;
            outline: none;
            background-color: #fafafa;
            -webkit-user-select: text;
            user-select: text;
        }
        .api-input:focus {
            border-color: #333;
            background-color: #fff;
        }
        
        .api-textarea {
            width: 100%;
            min-height: 80px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 10px 12px;
            font-size: 14px;
            outline: none;
            resize: vertical;
            background-color: #fafafa;
            -webkit-user-select: text;
            user-select: text;
            line-height: 1.5;
        }
        .api-textarea:focus {
            border-color: #333;
            background-color: #fff;
        }
        
        .api-select {
            width: 100%;
            height: 40px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 0 12px;
            font-size: 14px;
            outline: none;
            background-color: #fafafa;
            cursor: pointer;
        }
        
        .api-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 14px 15px;
            border-bottom: 1px solid #f5f5f5;
        }
        .api-row:last-child {
            border-bottom: none;
        }
        
        .api-row-label {
            font-size: 15px;
            color: #333;
        }
        
        .api-slider-container {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .api-slider {
            width: 120px;
            height: 4px;
            -webkit-appearance: none;
            appearance: none;
            background: #e0e0e0;
            border-radius: 2px;
            outline: none;
        }
        .api-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 18px;
            height: 18px;
            background: #333;
            border-radius: 50%;
            cursor: pointer;
        }
        
        .api-slider-value {
            font-size: 14px;
            color: #666;
            min-width: 40px;
            text-align: right;
        }
        
        .api-test-btn {
            width: 100%;
            height: 44px;
            background-color: #000;
            color: #fff;
            border: none;
            border-radius: 22px;
            font-size: 15px;
            font-weight: 500;
            cursor: pointer;
            margin: 15px 0;
        }
        .api-test-btn:active {
            opacity: 0.8;
        }
        
        .api-status {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 12px 15px;
            background-color: #f5f5f5;
            border-radius: 8px;
            margin: 0 15px 15px;
        }
        
        .api-status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: #ccc;
        }
        .api-status-dot.connected {
            background-color: #52c41a;
        }
        .api-status-dot.error {
            background-color: #ff4d4f;
        }
        
        .api-status-text {
            font-size: 13px;
            color: #666;
        }

        .hidden {
            display: none !important;
        }
        
        .loading-spinner {
            width: 24px;
            height: 24px;
            border: 2px solid #f0f0f0;
            border-top-color: #333;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div id="app-container">
        
        <!-- 顶部导航栏 -->
        <div class="top-nav" id="top-nav">
            <div class="user-info" id="user-info">
                <div class="user-avatar" id="user-avatar-display">薯</div>
                <div class="user-name">薯片机用户</div>
            </div>
            <div class="add-btn" id="add-btn">
                <svg class="icon-svg" viewBox="0 0 24 24">
                    <line x1="12" y1="5" x2="12" y2="19"></line>
                    <line x1="5" y1="12" x2="19" y2="12"></line>
                </svg>
            </div>
        </div>

        <!-- 添加弹窗 -->
        <div class="add-popup" id="add-popup">
            <div class="popup-item" id="add-friend-btn">
                <div class="popup-icon">
                    <svg class="icon-svg" viewBox="0 0 24 24">
                        <circle cx="10" cy="8" r="4"></circle>
                        <path d="M2 20c0-4 4-6 8-6"></path>
                        <line x1="19" y1="11" x2="19" y2="17"></line>
                        <line x1="16" y1="14" x2="22" y2="14"></line>
                    </svg>
                </div>
                <div class="popup-text">添加AI好友</div>
            </div>
            <div class="popup-divider"></div>
            <div class="popup-item" id="create-group-btn">
                <div class="popup-icon">
                    <svg class="icon-svg" viewBox="0 0 24 24">
                        <circle cx="9" cy="7" r="3"></circle>
                        <circle cx="15" cy="7" r="3"></circle>
                        <path d="M3 19c0-3 3-5 6-5"></path>
                        <path d="M15 14c3 0 6 2 6 5"></path>
                        <line x1="12" y1="17" x2="12" y2="21"></line>
                        <line x1="10" y1="19" x2="14" y2="19"></line>
                    </svg>
                </div>
                <div class="popup-text">创建AI群聊</div>
            </div>
            <div class="popup-divider"></div>
            <div class="popup-item" id="import-card-btn">
                <div class="popup-icon">
                    <svg class="icon-svg" viewBox="0 0 24 24">
                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                        <polyline points="7 10 12 15 17 10"></polyline>
                        <line x1="12" y1="15" x2="12" y2="3"></line>
                    </svg>
                </div>
                <div class="popup-text">导入角色卡</div>
            </div>
        </div>

        <!-- 侧边功能栏 -->
        <div class="side-menu" id="side-menu">
            <div class="card-info" id="card-info">
                <div class="card-bg" id="card-bg"></div>
                <div class="card-content">
                    <div class="card-avatar" id="card-avatar">薯</div>
                    <div class="card-name" id="display-name">薯片机用户</div>
                    <div class="card-signature" id="card-signature">这个人很懒，什么都没写~</div>
                </div>
            </div>
            
            <div class="menu-list">
                <div class="menu-item" data-func="wallet">
                    <div class="menu-icon">
                        <svg class="icon-svg" viewBox="0 0 24 24">
                            <rect x="2" y="6" width="20" height="14" rx="2"></rect>
                            <path d="M2 10h20"></path>
                            <circle cx="16" cy="14" r="1.5"></circle>
                        </svg>
                    </div>
                    <div class="menu-text">钱包</div>
                </div>
                
                <div class="menu-item" data-func="collection">
                    <div class="menu-icon">
                        <svg class="icon-svg" viewBox="0 0 24 24">
                            <path d="M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z"></path>
                        </svg>
                    </div>
                    <div class="menu-text">收藏</div>
                </div>
                
                <div class="menu-icon">
                        <svg class="icon-svg" viewBox="0 0 24 24">
                            <circle cx="12" cy="12" r="10"></circle>
                            <path d="M8 14s1.5 2 4 2 4-2 4-2"></path>
                            <line x1="9" y1="9" x2="9.01" y2="9"></line>
                            <line x1="15" y1="9" x2="15.01" y2="9"></line>
                        </svg>
                    </div>
                    <div class="menu-text">表情包</div>
                </div>
                
                <div class="menu-item" data-func="worldbook">
                    <div class="menu-icon">
                        <svg class="icon-svg" viewBox="0 0 24 24">
                            <path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"></path>
                            <path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"></path>
                            <circle cx="12" cy="10" r="3"></circle>
                            <path d="M12 13v2"></path>
                        </svg>
                    </div>
                    <div class="menu-text">世界书</div>
                </div>
                
                <div class="menu-divider"></div>
                
                <div class="menu-item" data-func="decoration">
                    <div class="menu-icon">
                        <svg class="icon-svg" viewBox="0 0 24 24">
                            <circle cx="12" cy="12" r="3"></circle>
                            <path d="M12 2v4"></path>
                            <path d="M12 18v4"></path>
                            <path d="M4.93 4.93l2.83 2.83"></path>
                            <path d="M16.24 16.24l2.83 2.83"></path>
                            <path d="M2 12h4"></path>
                            <path d="M18 12h4"></path>
                            <path d="M4.93 19.07l2.83-2.83"></path>
                            <path d="M16.24 7.76l2.83-2.83"></path>
                        </svg>
                    </div>
                    <div class="menu-text">个性装扮</div>
                </div>
                
                <div class="menu-item" data-func="api-settings">
                    <div class="menu-icon">
                        <svg class="icon-svg" viewBox="0 0 24 24">
                            <rect x="3" y="3" width="7" height="7" rx="1"></rect>
                            <rect x="14" y="3" width="7" height="7" rx="1"></rect>
                            <rect x="3" y="14" width="7" height="7" rx="1"></rect>
                            <circle cx="17.5" cy="17.5" r="3.5"></circle>
                        </svg>
                    </div>
                    <div class="menu-text">API设置</div>
                </div>
                
                <div class="menu-item" data-func="chat-summary">
                    <div class="menu-icon">
                        <svg class="icon-svg" viewBox="0 0 24 24">
                            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                            <polyline points="14 2 14 8 20 8"></polyline>
                            <line x1="16" y1="13" x2="8" y2="13"></line>
                            <line x1="16" y1="17" x2="8" y2="17"></line>
                            <line x1="10" y1="9" x2="8" y2="9"></line>
                        </svg>
                    </div>
                    <div class="menu-text">聊天总结</div>
                </div>
                
                <div class="menu-divider"></div>
                
                <div class="menu-item" data-func="settings">
                    <div class="menu-icon">
                        <svg class="icon-svg" viewBox="0 0 24 24">
                            <circle cx="12" cy="12" r="3"></circle>
                            <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-4 0v-.09a1.65 1.65 0 0 0-1-1.51 1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1 0-4h.09a1.65 1.65 0 0 0 1.51-1 1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 2.83-2.83l.06.06a1.65 1.65 0 0 0 1.82.33h.09a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82v.09a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1z"></path>
                        </svg>
                    </div>
                    <div class="menu-text">设置</div>
                </div>
            </div>
        </div>

        <!-- 遮罩层 -->
        <div class="mask" id="mask"></div>

        <!-- 消息页面 -->
        <div class="main-content msg-page active" id="msg-page">
            <div class="search-bar">
                <div class="search-wrapper">
                    <svg class="icon-svg search-icon" viewBox="0 0 24 24">
                        <circle cx="11" cy="11" r="8"></circle>
                        <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                    </svg>
                    <input type="text" class="search-input" placeholder="搜索" id="search-input-msg">
                </div>
            </div>
            
            <div class="msg-list" id="msg-list">
                <div class="empty-state" id="msg-empty">
                    <div class="empty-icon">
                        <svg class="icon-svg" viewBox="0 0 24 24" style="width:100%;height:100%;">
                            <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
                            <line x1="9" y1="10" x2="15" y2="10"></line>
                        </svg>
                    </div>
                    <div class="empty-text">暂无消息<br>点击右上角添加AI好友开始聊天</div>
                </div>
            </div>
        </div>

        <!-- 好友页面 -->
        <div class="main-content friend-page" id="friend-page">
            <div class="search-bar">
                <div class="search-wrapper">
                    <svg class="icon-svg search-icon" viewBox="0 0 24 24">
                        <circle cx="11" cy="11" r="8"></circle>
                        <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                    </svg>
                    <input type="text" class="search-input" placeholder="搜索好友" id="search-input-friend">
                </div>
            </div>
            
            <div class="friend-content" id="friend-content">
                <div class="friend-group">
                    <div class="group-header" data-group="common">
                        <div class="group-title-left">
                            <div class="group-arrow"></div>
                            <div class="group-title">我的好友</div>
                            <div class="group-count">(0/0)</div>
                        </div>
                        <div class="group-edit">管理</div>
                    </div>
                    <div class="friend-list show" data-group="common">
                        <div class="empty-state" style="padding: 30px 20px;">
                            <div class="empty-text">暂无好友</div>
                        </div>
                    </div>
                </div>
                
                <div class="friend-group">
                    <div class="group-header collapsed" data-group="groups">
                        <div class="group-title-left">
                            <div class="group-arrow"></div>
                            <div class="group-title">群聊管理</div>
                            <div class="group-count">(0/0)</div>
                        </div>
                        <div class="group-edit">管理</div>
                    </div>
                    <div class="friend-list" data-group="groups">
                        <div class="empty-state" style="padding: 30px 20px;">
                            <div class="empty-text">暂无群聊</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 动态页面 - 重新设计的布局 -->
        <div class="main-content dynamic-page" id="dynamic-page">
            <div class="dynamic-content">
                <!-- 社交功能 -->
                <div class="func-section">
                    <div class="func-row" data-page="moments-page" data-func-id="moments">
                        <div class="func-row-icon blue">
                            <svg class="icon-svg" viewBox="0 0 24 24">
                                <rect x="3" y="3" width="18" height="18" rx="2"></rect>
                                <circle cx="8.5" cy="8.5" r="1.5"></circle>
                                <path d="M21 15l-5-5L5 21"></path>
                            </svg>
                        </div>
                        <div class="func-row-content">
                            <div class="func-row-name">朋友圈</div>
                        </div>
                        <div class="func-row-arrow"></div>
                    </div>
                    
                    <div class="func-row" data-page="calendar-page" data-func-id="calendar">
                        <div class="func-row-icon orange">
                            <svg class="icon-svg" viewBox="0 0 24 24">
                                <rect x="3" y="4" width="18" height="18" rx="2"></rect>
                                <line x1="16" y1="2" x2="16" y2="6"></line>
                                <line x1="8" y1="2" x2="8" y2="6"></line>
                                <line x1="3" y1="10" x2="21" y2="10"></line>
                            </svg>
                        </div>
                        <div class="func-row-content">
                            <div class="func-row-name">日历</div>
                        </div>
                        <div class="func-row-arrow"></div>
                    </div>
                </div>
                
                <!-- 内容平台 -->
                <div class="func-section">
                    <div class="func-row" data-page="forum-page" data-func-id="forum">
                        <div class="func-row-icon green">
                            <svg class="icon-svg" viewBox="0 0 24 24">
                                <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
                                <line x1="8" y1="8" x2="16" y2="8"></line>
                                <line x1="8" y1="12" x2="14" y2="12"></line>
                            </svg>
                        </div>
                        <div class="func-row-content">
                            <div class="func-row-name">论坛</div>
                        </div>
                        <div class="func-row-arrow"></div>
                    </div>
                    
                    <div class="func-row" data-page="xiaohongshu-page" data-func-id="xiaohongshu">
                        <div class="func-row-icon red">
                            <svg class="icon-svg" viewBox="0 0 24 24">
                                <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path>
                                <path d="M12 8v8"></path>
                                <path d="M8 12h8"></path>
                            </svg>
                        </div>
                        <div class="func-row-content">
                            <div class="func-row-name">小红书</div>
                        </div>
                        <div class="func-row-arrow"></div>
                    </div>
                </div>
                
                <!-- 娱乐功能 -->
                <div class="func-section">
                    <div class="func-row" data-page="game-page" data-func-id="game">
                        <div class="func-row-icon purple">
                            <svg class="icon-svg" viewBox="0 0 24 24">
                                <rect x="2" y="6" width="20" height="12" rx="2"></rect>
                                <circle cx="6" cy="12" r="1.5"></circle>
                                <circle cx="10" cy="12" r="1.5"></circle>
                                <path d="M15 10v4"></path>
                                <path d="M13 12h4"></path>
                            </svg>
                        </div>
                        <div class="func-row-content">
                            <div class="func-row-name">游戏中心</div>
                        </div>
                        <div class="func-row-arrow"></div>
                    </div>
                    
                    <div class="func-row" data-page="reading-page" data-func-id="reading">
                        <div class="func-row-icon cyan">
                            <svg class="icon-svg" viewBox="0 0 24 24">
                                <path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"></path>
                                <path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"></path>
                                <line x1="8" y1="7" x2="16" y2="7"></line>
                                <line x1="8" y1="11" x2="14" y2="11"></line>
                            </svg>
                        </div>
                        <div class="func-row-content">
                            <div class="func-row-name">阅读</div>
                        </div>
                        <div class="func-row-arrow"></div>
                    </div>
                </div>
                
                <!-- 工具功能 -->
                <div class="func-section">
                    <div class="func-row" data-page="sillytavern-page" data-func-id="sillytavern">
                        <div class="func-row-icon gray">
                            <svg class="icon-svg" viewBox="0 0 24 24">
                                <polygon points="12 2 2 7 12 12 22 7 12 2"></polygon>
                                <polyline points="2 17 12 22 22 17"></polyline>
                                <polyline points="2 12 12 17 22 12"></polyline>
                            </svg>
                        </div>
                        <div class="func-row-content">
                            <div class="func-row-name">SillyTavern简约版</div>
                        </div>
                        <div class="func-row-arrow"></div>
                    </div>
                </div>
                
                <!-- 更多功能按钮 -->
                <div class="more-func-item" id="more-func-btn">
                    <div class="more-func-text">更多功能 ›</div>
                </div>
            </div>
        </div>

        <!-- 底部标签栏 -->
        <div class="tab-bar" id="tab-bar">
            <div class="tab-item active" data-tab="msg-page">
                <div class="tab-icon">
                    <svg class="icon-svg" viewBox="0 0 24 24">
                        <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
                    </svg>
                </div>
                <div class="tab-text">消息</div>
            </div>
            <div class="tab-item" data-tab="friend-page">
                <div class="tab-icon">
                    <svg class="icon-svg" viewBox="0 0 24 24">
                        <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                        <circle cx="9" cy="7" r="4"></circle>
                        <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                        <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                    </svg>
                </div>
                <div class="tab-text">好友</div>
            </div>
            <div class="tab-item" data-tab="dynamic-page">
                <div class="tab-icon">
                    <svg class="icon-svg" viewBox="0 0 24 24">
                        <circle cx="12" cy="12" r="10"></circle>
                        <path d="M12 6v6l4 2"></path>
                    </svg>
                </div>
                <div class="tab-text">动态</div>
            </div>
        </div>

        <!-- 添加好友页面 -->
        <div class="add-friend-page" id="add-friend-page">
            <div class="sub-nav">
                <div class="back-btn" id="add-friend-back-btn">
                    <div class="back-arrow"></div>
                    <span>返回</span>
                </div>
                <div class="sub-title">添加AI好友</div>
            </div>
            <div class="add-page-content">
                <div class="add-section">
                    <div class="add-section-header">基本信息</div>
                    <div class="add-input-group">
                        <label class="add-input-label">名称 *</label>
                        <input type="text" class="add-input" id="friend-name-input" placeholder="输入AI好友名称">
                    </div>
                    <div class="add-input-group">
                        <label class="add-input-label">头像URL（可选）</label>
                        <input type="text" class="add-input" id="friend-avatar-input" placeholder="输入头像图片链接">
                    </div>
                    <div class="add-input-group">
                        <label class="add-input-label">人设描述（可选）</label>
                        <textarea class="add-textarea" id="friend-desc-input" placeholder="描述AI的性格、背景等..."></textarea>
                    </div>
                    <div class="add-input-group">
                        <label class="add-input-label">开场白（可选）</label>
                        <textarea class="add-textarea" id="friend-greeting-input" placeholder="AI第一次见面时说的话..."></textarea>
                    </div>
                </div>
                
                <div class="add-btn-group">
                    <button class="add-cancel-btn" id="add-friend-cancel">取消</button>
                    <button class="add-submit-btn" id="add-friend-submit">添加好友</button>
                </div>
            </div>
        </div>

        <!-- 创建群聊页面 -->
        <div class="add-friend-page" id="create-group-page">
            <div class="sub-nav">
                <div class="back-btn" id="create-group-back-btn">
                    <div class="back-arrow"></div>
                    <span>返回</span>
                </div>
                <div class="sub-title">创建AI群聊</div>
            </div>
            <div class="add-page-content">
                <div class="add-section">
                    <div class="add-section-header">群聊信息</div>
                    <div class="add-input-group">
                        <label class="add-input-label">群名称 *</label>
                        <input type="text" class="add-input" id="group-name-input" placeholder="输入群聊名称">
                    </div>
                    <div class="add-input-group">
                        <label class="add-input-label">群头像URL（可选）</label>
                        <input type="text" class="add-input" id="group-avatar-input" placeholder="输入群头像图片链接">
                    </div>
                    <div class="add-input-group">
                        <label class="add-input-label">群描述（可选）</label>
                        <textarea class="add-textarea" id="group-desc-input" placeholder="描述群聊的主题..."></textarea>
                    </div>
                </div>
                
                <div class="add-btn-group">
                    <button class="add-cancel-btn" id="create-group-cancel">取消</button>
                    <button class="add-submit-btn" id="create-group-submit">创建群聊</button>
                </div>
            </div>
        </div>

        <!-- 导入角色卡页面 -->
        <div class="add-friend-page" id="import-card-page">
            <div class="sub-nav">
                <div class="back-btn" id="import-card-back-btn">
                    <div class="back-arrow"></div>
                    <span>返回</span>
                </div>
                <div class="sub-title">导入角色卡</div>
            </div>
            <div class="add-page-content">
                <div class="import-section">
                    <div class="import-title">
                        <svg class="icon-svg" viewBox="0 0 24 24" style="width:20px;height:20px;">
                            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                            <polyline points="14 2 14 8 20 8"></polyline>
                        </svg>
                        批量导入角色卡
                    </div>
                    <div class="import-desc">
                        支持 SillyTavern 格式的 JSON 角色卡文件，可一次选择多个文件批量导入。
                    </div>
                    <div class="import-btn" id="import-file-btn">
                        <svg class="icon-svg" viewBox="0 0 24 24" style="width:20px;height:20px;">
                            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                            <polyline points="17 8 12 3 7 8"></polyline>
                            <line x1="12" y1="3" x2="12" y2="15"></line>
                        </svg>
                        点击选择文件
                    </div>
                    <input type="file" class="import-file-input" id="import-file-input" accept=".json" multiple>
                    
                    <div class="import-preview" id="import-preview"></div>
                    <button class="import-all-btn" id="import-all-btn">导入全部角色</button>
                </div>
                
                <div class="import-section">
                    <div class="import-title">
                        <svg class="icon-svg" viewBox="0 0 24 24" style="width:20px;height:20px;">
                            <circle cx="12" cy="12" r="10"></circle>
                            <line x1="12" y1="16" x2="12" y2="12"></line>
                            <line x1="12" y1="8" x2="12.01" y2="8"></line>
                        </svg>
                        角色卡格式说明
                    </div>
                    <div class="import-desc">
                        支持的JSON格式：<br>
                        • SillyTavern V2 格式 (spec: chara_card_v2)<br>
                        • SillyTavern V1 格式<br>
                        • 简单格式 {name, description, first_mes}<br><br>
                        必需字段：name（角色名称）<br>
                        可选字段：description, personality, first_mes, avatar, scenario, mes_example
                    </div>
                </div>
            </div>
        </div>

        <!-- 子页面 - 朋友圈 -->
        <div class="sub-page" id="moments-page">
            <div class="sub-nav">
                <div class="back-btn" data-back="moments-page">
                    <div class="back-arrow"></div>
                    <span>返回</span>
                </div>
                <div class="sub-title">朋友圈</div>
            </div>
            <div class="sub-content">
                <div class="placeholder-text">
                    【朋友圈功能开发中】
                </div>
            </div>
        </div>

        <!-- 子页面 - 日历 -->
        <div class="sub-page" id="calendar-page">
            <div class="sub-nav">
                <div class="back-btn" data-back="calendar-page">
                    <div class="back-arrow"></div>
                    <span>返回</span>
                </div>
                <div class="sub-title">日历</div>
            </div>
            <div class="sub-content">
                <div class="placeholder-text">
                    【日历功能开发中】
                </div>
            </div>
        </div>

        <!-- 子页面 - 论坛 -->
        <div class="sub-page" id="forum-page">
            <div class="sub-nav">
                <div class="back-btn" data-back="forum-page">
                    <div class="back-arrow"></div>
                    <span>返回</span>
                </div>
                <div class="sub-title">论坛</div>
            </div>
            <div class="sub-content">
                <div class="placeholder-text">
                    【论坛功能开发中】
                </div>
            </div>
        </div>

        <!-- 子页面 - 小红书 -->
        <div class="sub-page" id="xiaohongshu-page">
            <div class="sub-nav">
                <div class="back-btn" data-back="xiaohongshu-page">
                    <div class="back-arrow"></div>
                    <span>返回</span>
                </div>
                <div class="sub-title">小红书</div>
            </div>
            <div class="sub-content">
                <div class="placeholder-text">
                    【小红书功能开发中】
                </div>
            </div>
        </div>

        <!-- 子页面 - 游戏中心 -->
        <div class="sub-page" id="game-page">
            <div class="sub-nav">
                <div class="back-btn" data-back="game-page">
                    <div class="back-arrow"></div>
                    <span>返回</span>
                </div>
                <div class="sub-title">游戏中心</div>
            </div>
            <div class="sub-content">
                <div class="placeholder-text">
                    【游戏中心开发中】
                </div>
            </div>
        </div>

        <!-- 子页面 - 阅读 -->
        <div class="sub-page" id="reading-page">
            <div class="sub-nav">
                <div class="back-btn" data-back="reading-page">
                    <div class="back-arrow"></div>
                    <span>返回</span>
                </div>
                <div class="sub-title">阅读</div>
            </div>
            <div class="sub-content">
                <div class="placeholder-text">
                    【阅读功能开发中】
                </div>
            </div>
        </div>

        <!-- 子页面 - SillyTavern简约版 -->
        <div class="sub-page" id="sillytavern-page">
            <div class="sub-nav">
                <div class="back-btn" data-back="sillytavern-page">
                    <div class="back-arrow"></div>
                    <span>返回</span>
                </div>
                <div class="sub-title">SillyTavern简约版</div>
            </div>
            <div class="sub-content">
                <div class="placeholder-text">
                    【SillyTavern简约版开发中】
                </div>
            </div>
        </div>

        <!-- 子页面 - API设置 (完整功能) -->
        <div class="sub-page" id="api-settings-page">
            <div class="sub-nav">
                <div class="back-btn" data-back="api-settings-page">
                    <div class="back-arrow"></div>
                    <span>返回</span>
                </div>
                <div class="sub-title">API设置</div>
            </div>
            <div class="sub-content api-settings-content">
                <!-- 连接状态 -->
                <div class="api-status" id="api-status">
                    <div class="api-status-dot" id="api-status-dot"></div>
                    <div class="api-status-text" id="api-status-text">未连接</div>
                </div>
                
                <!-- API类型选择 -->
                <div class="api-section">
                    <div class="api-section-title">API类型</div>
                    <div class="api-item">
                        <select class="api-select" id="api-type">
                            <option value="openai">OpenAI Compatible</option>
                            <option value="claude">Claude API</option>
                            <option value="gemini">Google Gemini</option>
                            <option value="custom">自定义API</option>
                        </select>
                    </div>
                </div>
                
                <!-- API连接设置 -->
                <div class="api-section">
                    <div class="api-section-title">连接设置</div>
                    <div class="api-item">
                        <div class="api-item-label">API地址</div>
                        <input type="text" class="api-input" id="api-url" placeholder="https://api.openai.com/v1">
                    </div>
                    <div class="api-item">
                        <div class="api-item-label">API密钥</div>
                        <input type="password" class="api-input" id="api-key" placeholder="sk-...">
                    </div>
                    <div class="api-item">
                        <div class="api-item-label">模型名称</div>
                        <input type="text" class="api-input" id="api-model" placeholder="gpt-4o-mini">
                    </div>
                </div>
                
                <!-- 生成参数 -->
                <div class="api-section">
                    <div class="api-section-title">生成参数</div>
                    <div class="api-row">
                        <div class="api-row-label">Temperature</div>
                        <div class="api-slider-container">
                            <input type="range" class="api-slider" id="api-temperature" min="0" max="200" value="70">
                            <div class="api-slider-value" id="api-temperature-value">0.7</div>
                        </div>
                    </div>
                    <div class="api-row">
                        <div class="api-row-label">Top P</div>
                        <div class="api-slider-container">
                            <input type="range" class="api-slider" id="api-top-p" min="0" max="100" value="90">
                            <div class="api-slider-value" id="api-top-p-value">0.9</div>
                        </div>
                    </div>
                    <div class="api-row">
                        <div class="api-row-label">Max Tokens</div>
                        <div class="api-slider-container">
                            <input type="range" class="api-slider" id="api-max-tokens" min="100" max="8000" value="2000">
                            <div class="api-slider-value" id="api-max-tokens-value">2000</div>
                        </div>
                    </div>
                    <div class="api-row">
                        <div class="api-row-label">Frequency Penalty</div>
                        <div class="api-slider-container">
                            <input type="range" class="api-slider" id="api-freq-penalty" min="0" max="200" value="0">
                            <div class="api-slider-value" id="api-freq-penalty-value">0</div>
                        </div>
                    </div>
                    <div class="api-row">
                        <div class="api-row-label">Presence Penalty</div>
                        <div class="api-slider-container">
                            <input type="range" class="api-slider" id="api-pres-penalty" min="0" max="200" value="0">
                            <div class="api-slider-value" id="api-pres-penalty-value">0</div>
                        </div>
                    </div>
                </div>
                
                <!-- AI时间感知 -->
                <div class="api-section">
                    <div class="api-section-title">AI时间感知</div>
                    <div class="api-row">
                        <div class="api-row-label">启用时间感知</div>
                        <div class="toggle-switch" id="api-time-aware"></div>
                    </div>
                    <div class="api-item" id="time-format-container">
                        <div class="api-item-label">
                            时间格式
                            <span class="api-item-hint">将注入到系统提示词中</span>
                        </div>
                        <select class="api-select" id="api-time-format">
                            <option value="full">完整格式 (2024年1月15日 星期一 14:30)</option>
                            <option value="date">仅日期 (2024年1月15日)</option>
                            <option value="datetime">日期时间 (2024-01-15 14:30)</option>
                            <option value="relative">相对时间 (下午)</option>
                        </select>
                    </div>
                </div>
                
                <!-- 系统提示词 -->
                <div class="api-section">
                    <div class="api-section-title">系统提示词</div>
                    <div class="api-item">
                        <div class="api-item-label">
                            主系统提示词
                            <span class="api-item-hint">可选</span>
                        </div>
                        <textarea class="api-textarea" id="api-system-prompt" placeholder="输入全局系统提示词..."></textarea>
                    </div>
                    <div class="api-item">
                        <div class="api-item-label">
                            角色卡注入位置
                        </div>
                        <select class="api-select" id="api-char-position">
                            <option value="before">系统提示词之前</option>
                            <option value="after" selected>系统提示词之后</option>
                            <option value="replace">替换系统提示词</option>
                        </select>
                    </div>
                </div>
                
                <!-- 高级设置 -->
                <div class="api-section">
                    <div class="api-section-title">高级设置</div>
                    <div class="api-row">
                        <div class="api-row-label">流式输出</div>
                        <div class="toggle-switch active" id="api-streaming"></div>
                    </div>
                    <div class="api-row">
                        <div class="api-row-label">自动重试</div>
                        <div class="toggle-switch active" id="api-auto-retry"></div>
                    </div>
                    <div class="api-row">
                        <div class="api-row-label">上下文长度限制</div>
                        <div class="api-slider-container">
                            <input type="range" class="api-slider" id="api-context-limit" min="1000" max="128000" value="16000">
                            <div class="api-slider-value" id="api-context-limit-value">16K</div>
                        </div>
                    </div>
                </div>
                
                <!-- 测试连接按钮 -->
                <div style="padding: 0 12px;">
                    <button class="api-test-btn" id="api-test-btn">测试连接</button>
                </div>
                
                <!-- 保存按钮 -->
                <div style="padding: 0 12px 20px;">
                    <button class="api-test-btn" id="api-save-btn" style="background-color: #52c41a;">保存设置</button>
                </div>
            </div>
        </div>

        <!-- 子页面 - 聊天总结 -->
        <div class="sub-page" id="chat-summary-page">
            <div class="sub-nav">
                <div class="back-btn" data-back="chat-summary-page">
                    <div class="back-arrow"></div>
                    <span>返回</span>
                </div>
                <div class="sub-title">聊天总结</div>
            </div>
            <div class="sub-content" style="padding: 0; background-color: #f5f5f5;">
                <div class="placeholder-text">
                    【聊天总结功能开发中】
                </div>
            </div>
        </div>

        <!-- 子页面 - 世界书 -->
        <div class="sub-page" id="worldbook-page">
            <div class="sub-nav">
                <div class="back-btn" data-back="worldbook-page">
                    <div class="back-arrow"></div>
                    <span>返回</span>
                </div>
                <div class="sub-title">世界书</div>
            </div>
            <div class="sub-content" style="padding: 0; background-color: #f5f5f5;">
                <div class="placeholder-text">
                    【世界书功能开发中】
                </div>
            </div>
        </div>

        <!-- 聊天页面 -->
        <div class="chat-page" id="chat-page">
            <div class="chat-nav">
                <div class="back-btn" id="chat-back-btn">
                    <div class="back-arrow"></div>
                    <span>返回</span>
                </div>
                <div class="chat-title" id="chat-title">AI小助手</div>
                <div class="chat-more">
                    <div class="chat-more-dots">
                        <span></span>
                        <span></span>
                        <span></span>
                    </div>
                </div>
            </div>
            
            <div class="chat-messages" id="chat-messages"></div>
            
            <div class="chat-input-area">
                <textarea class="chat-input" id="chat-input" placeholder="输入消息..." rows="1"></textarea>
                <!-- AI回复按钮 -->
                <button class="chat-ai-btn" id="chat-ai-btn" title="让AI回复">
                    <svg viewBox="0 0 24 24">
                        <path d="M12 2a2 2 0 0 1 2 2c0 .74-.4 1.39-1 1.73V7h1a7 7 0 0 1 7 7h1a1 1 0 0 1 1 1v3a1 1 0 0 1-1 1h-1v1a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-1H2a1 1 0 0 1-1-1v-3a1 1 0 0 1 1-1h1a7 7 0 0 1 7-7h1V5.73c-.6-.34-1-.99-1-1.73a2 2 0 0 1 2-2z"></path>
                        <circle cx="9" cy="13" r="1.25"></circle>
                        <circle cx="15" cy="13" r="1.25"></circle>
                    </svg>
                </button>
                <button class="chat-send-btn" id="chat-send-btn">
                    <svg viewBox="0 0 24 24">
                        <line x1="22" y1="2" x2="11" y2="13"></line>
                        <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
                    </svg>
                </button>
            </div>
        </div>

        <!-- 个性名片编辑页面 -->
        <div class="card-edit-page" id="card-edit-page">
            <div class="sub-nav">
                <div class="back-btn" id="card-edit-back-btn">
                    <div class="back-arrow"></div>
                    <span>返回</span>
                </div>
                <div class="sub-title">编辑资料</div>
            </div>
            
            <div class="card-edit-preview" id="card-edit-preview">
                <div class="card-edit-preview-avatar" id="card-edit-preview-avatar">薯</div>
                <div class="card-edit-preview-name" id="card-edit-preview-name">薯片机用户</div>
                <div class="card-edit-preview-sig" id="card-edit-preview-sig">这个人很懒，什么都没写~</div>
            </div>
            
            <div class="edit-list">
                <div class="edit-section">
                    <div class="edit-item" id="edit-avatar-btn">
                        <div class="edit-label">头像</div>
                        <div class="edit-value">
                            <div class="edit-avatar-small" id="edit-avatar-small"></div>
                            <div class="edit-arrow"></div>
                        </div>
                    </div>
                    
                    <div class="edit-item" id="edit-bg-btn">
                        <div class="edit-label">背景图</div>
                        <div class="edit-value">
                            <span id="edit-bg-value">默认</span>
                            <div class="edit-arrow"></div>
                        </div>
                    </div>
                    
                    <div class="edit-item" id="edit-name-btn">
                        <div class="edit-label">昵称</div>
                        <div class="edit-value">
                            <span id="edit-name-value">薯片机用户</span>
                            <div class="edit-arrow"></div>
                        </div>
                    </div>
                    
                    <div class="edit-item" id="edit-signature-btn">
                        <div class="edit-label">个性签名</div>
                        <div class="edit-value">
                            <span id="edit-signature-value">这个人很懒，什么都没写~</span>
                            <div class="edit-arrow"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 图片选择弹窗 -->
        <div class="image-picker-modal" id="image-picker-modal">
            <div class="image-picker-content">
                <div class="picker-title" id="picker-title">选择图片</div>
                
                <div class="picker-option" id="picker-local">
                    <div class="picker-option-icon">
                        <svg class="icon-svg" viewBox="0 0 24 24" style="width:24px;height:24px;">
                            <rect x="3" y="3" width="18" height="18" rx="2"></rect>
                            <circle cx="8.5" cy="8.5" r="1.5"></circle>
                            <path d="M21 15l-5-5L5 21"></path>
                        </svg>
                    </div>
                    <div class="picker-option-text">从本地相册选择</div>
                </div>
                
                <div class="picker-option" id="picker-url-toggle">
                    <div class="picker-option-icon">
                        <svg class="icon-svg" viewBox="0 0 24 24" style="width:24px;height:24px;">
                            <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path>
                            <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path>
                        </svg>
                    </div>
                    <div class="picker-option-text">输入图片URL</div>
                </div>
                
                <input type="text" class="picker-url-input hidden" id="picker-url-input" placeholder="请输入图片URL地址">
                <button class="picker-url-confirm hidden" id="picker-url-confirm">确认</button>
                
                <input type="file" id="picker-file-input" accept="image/*" style="display:none;">
                
                <button class="picker-cancel" id="picker-cancel">取消</button>
            </div>
        </div>

        <!-- 更多功能设置弹窗 -->
        <div class="more-settings-modal" id="more-settings-modal">
            <div class="more-settings-content">
                <div class="more-settings-header">
                    <div class="more-settings-title">动态页面设置</div>
                    <div class="more-settings-desc">选择要在动态页面显示的功能</div>
                </div>
                
                <div class="more-settings-list" id="more-settings-list">
                    <div class="more-settings-item" data-func-id="moments">
                        <div class="more-settings-item-left">
                            <div class="more-settings-item-icon">
                                <svg class="icon-svg" viewBox="0 0 24 24">
                                    <rect x="3" y="3" width="18" height="18" rx="2"></rect>
                                    <circle cx="8.5" cy="8.5" r="1.5"></circle>
                                    <path d="M21 15l-5-5L5 21"></path>
                                </svg>
                            </div>
                            <div class="more-settings-item-name">朋友圈</div>
                        </div>
                        <div class="toggle-switch active" data-func-id="moments"></div>
                    </div>
                    
                    <div class="more-settings-item" data-func-id="calendar">
                        <div class="more-settings-item-left">
                            <div class="more-settings-item-icon">
                                <svg class="icon-svg" viewBox="0 0 24 24">
                                    <rect x="3" y="4" width="18" height="18" rx="2"></rect>
                                    <line x1="16" y1="2" x2="16" y2="6"></line>
                                    <line x1="8" y1="2" x2="8" y2="6"></line>
                                    <line x1="3" y1="10" x2="21" y2="10"></line>
                                </svg>
                            </div>
                            <div class="more-settings-item-name">日历</div>
                        </div>
                        <div class="toggle-switch active" data-func-id="calendar"></div>
                    </div>
                    
                    <div class="more-settings-item" data-func-id="forum">
                        <div class="more-settings-item-left">
                            <div class="more-settings-item-icon">
                                <svg class="icon-svg" viewBox="0 0 24 24">
                                    <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
                                    <line x1="8" y1="8" x2="16" y2="8"></line>
                                    <line x1="8" y1="12" x2="14" y2="12"></line>
                                </svg>
                            </div>
                            <div class="more-settings-item-name">论坛</div>
                        </div>
                        <div class="toggle-switch active" data-func-id="forum"></div>
                    </div>
                    
                    <div class="more-settings-item" data-func-id="xiaohongshu">
                        <div class="more-settings-item-left">
                            <div class="more-settings-item-icon">
                                <svg class="icon-svg" viewBox="0 0 24 24">
                                    <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path>
                                    <path d="M12 8v8"></path>
                                    <path d="M8 12h8"></path>
                                </svg>
                            </div>
                            <div class="more-settings-item-name">小红书</div>
                        </div>
                        <div class="toggle-switch active" data-func-id="xiaohongshu"></div>
                    </div>
                    
                    <div class="more-settings-item" data-func-id="game">
                        <div class="more-settings-item-left">
                            <div class="more-settings-item-icon">
                                <svg class="icon-svg" viewBox="0 0 24 24">
                                    <rect x="2" y="6" width="20" height="12" rx="2"></rect>
                                    <circle cx="6" cy="12" r="1.5"></circle>
                                    <circle cx="10" cy="12" r="1.5"></circle>
                                    <path d="M15 10v4"></path>
                                    <path d="M13 12h4"></path>
                                </svg>
                            </div>
                            <div class="more-settings-item-name">游戏中心</div>
                        </div>
                        <div class="toggle-switch active" data-func-id="game"></div>
                    </div>
                    
                    <div class="more-settings-item" data-func-id="reading">
                        <div class="more-settings-item-left">
                            <div class="more-settings-item-icon">
                                <svg class="icon-svg" viewBox="0 0 24 24">
                                    <path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"></path>
                                    <path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"></path>
                                    <line x1="8" y1="7" x2="16" y2="7"></line>
                                    <line x1="8" y1="11" x2="14" y2="11"></line>
                                </svg>
                            </div>
                            <div class="more-settings-item-name">阅读</div>
                        </div>
                        <div class="toggle-switch active" data-func-id="reading"></div>
                    </div>
                    
                    <div class="more-settings-item" data-func-id="sillytavern">
                        <div class="more-settings-item-left">
                            <div class="more-settings-item-icon">
                                <svg class="icon-svg" viewBox="0 0 24 24">
                                    <polygon points="12 2 2 7 12 12 22 7 12 2"></polygon>
                                    <polyline points="2 17 12 22 22 17"></polyline>
                                    <polyline points="2 12 12 17 22 12"></polyline>
                                </svg>
                            </div>
                            <div class="more-settings-item-name">SillyTavern简约版</div>
                        </div>
                        <div class="toggle-switch active" data-func-id="sillytavern"></div>
                    </div>
                </div>
                
                <div class="more-settings-footer">
                    <button class="more-settings-confirm" id="more-settings-confirm">确定</button>
                </div>
            </div>
        </div>

    </div>

    <script>
        // 应用状态
        const AppState = {
            currentTab: 'msg-page',
            currentChat: null,
            friends: [],
            groups: [],
            messages: {},
            conversations: [],
            user: {
                name: '薯片机用户',
                avatar: '',
                signature: '这个人很懒，什么都没写~',
                bgImage: ''
            },
            dynamicFuncs: {
                moments: true,
                calendar: true,
                forum: true,
                xiaohongshu: true,
                game: true,
                reading: true,
                sillytavern: true
            },
            importedCards: [],
            apiSettings: {
                type: 'openai',
                url: '',
                key: '',
                model: 'gpt-4o-mini',
                temperature: 0.7,
                topP: 0.9,
                maxTokens: 2000,
                freqPenalty: 0,
                presPenalty: 0,
                timeAware: false,
                timeFormat: 'full',
                systemPrompt: '',
                charPosition: 'after',
                streaming: true,
                autoRetry: true,
                contextLimit: 16000,
                connected: false
            }
        };

        // 初始化
        document.addEventListener('DOMContentLoaded', function() {
            loadFromStorage();
            initEventListeners();
            renderUI();
            updateDynamicFuncList();
            initAPISettings();
        });

        // 从本地存储加载数据
        function loadFromStorage() {
            try {
                const savedState = localStorage.getItem('shupianjAppState');
                if (savedState) {
                    const parsed = JSON.parse(savedState);
                    Object.assign(AppState, parsed);
                }
            } catch (e) {
                console.error('加载数据失败:', e);
            }
        }

        // 保存到本地存储
        function saveToStorage() {
            try {
                localStorage.setItem('shupianjAppState', JSON.stringify(AppState));
            } catch (e) {
                console.error('保存数据失败:', e);
            }
        }

        // 初始化事件监听
        function initEventListeners() {
            // 用户信息点击 - 打开侧边栏
            document.getElementById('user-info').addEventListener('click', function() {
                document.getElementById('side-menu').classList.add('open');
                document.getElementById('mask').classList.add('show');
            });

            // 遮罩层点击
            document.getElementById('mask').addEventListener('click', function() {
                closeSideMenu();
                closeAddPopup();
            });

            // 添加按钮
            document.getElementById('add-btn').addEventListener('click', function(e) {
                e.stopPropagation();
                toggleAddPopup();
            });

            // 点击其他地方关闭弹窗
            document.addEventListener('click', function(e) {
                if (!e.target.closest('#add-popup') && !e.target.closest('#add-btn')) {
                    closeAddPopup();
                }
            });

            // 底部标签栏
            document.querySelectorAll('.tab-item').forEach(function(tab) {
                tab.addEventListener('click', function() {
                    switchTab(this.dataset.tab);
                });
            });

            // 好友分组折叠
            document.querySelectorAll('.group-header').forEach(function(header) {
                header.addEventListener('click', function() {
                    const group = this.dataset.group;
                    const list = document.querySelector(`.friend-list[data-group="${group}"]`);
                    this.classList.toggle('collapsed');
                    list.classList.toggle('show');
                });
            });

            // 动态页面功能项
            document.querySelectorAll('.func-row').forEach(function(item) {
                item.addEventListener('click', function() {
                    const pageId = this.dataset.page;
                    if (pageId) {
                        openSubPage(pageId);
                    }
                });
            });

            // 子页面返回按钮
            document.querySelectorAll('.back-btn[data-back]').forEach(function(btn) {
                btn.addEventListener('click', function() {
                    const pageId = this.dataset.back;
                    closeSubPage(pageId);
                });
            });

            // 侧边栏菜单项
            document.querySelectorAll('.menu-item').forEach(function(item) {
                item.addEventListener('click', function() {
                    const func = this.dataset.func;
                    handleMenuClick(func);
                });
            });

            // 个性名片点击 - 直接跳转编辑页面
            document.getElementById('card-info').addEventListener('click', function() {
                closeSideMenu();
                setTimeout(function() {
                    openCardEditPage();
                }, 300);
            });

            // 添加好友相关
            document.getElementById('add-friend-btn').addEventListener('click', function() {
                closeAddPopup();
                openAddFriendPage();
            });

            document.getElementById('add-friend-back-btn').addEventListener('click', function() {
                closeAddFriendPage();
            });

            document.getElementById('add-friend-cancel').addEventListener('click', function() {
                closeAddFriendPage();
            });

            document.getElementById('add-friend-submit').addEventListener('click', function() {
                addFriend();
            });

            // 创建群聊相关
            document.getElementById('create-group-btn').addEventListener('click', function() {
                closeAddPopup();
                openCreateGroupPage();
            });

            document.getElementById('create-group-back-btn').addEventListener('click', function() {
                closeCreateGroupPage();
            });

            document.getElementById('create-group-cancel').addEventListener('click', function() {
                closeCreateGroupPage();
            });

            document.getElementById('create-group-submit').addEventListener('click', function() {
                createGroup();
            });

            // 导入角色卡相关
            document.getElementById('import-card-btn').addEventListener('click', function() {
                closeAddPopup();
                openImportCardPage();
            });

            document.getElementById('import-card-back-btn').addEventListener('click', function() {
                closeImportCardPage();
            });

            document.getElementById('import-file-btn').addEventListener('click', function() {
                document.getElementById('import-file-input').click();
            });

            document.getElementById('import-file-input').addEventListener('change', function(e) {
                handleFileImport(e.target.files);
            });

            document.getElementById('import-all-btn').addEventListener('click', function() {
                importAllCards();
            });

            // 聊天页面
            document.getElementById('chat-back-btn').addEventListener('click', function() {
                closeChatPage();
            });

            document.getElementById('chat-send-btn').addEventListener('click', function() {
                sendMessage();
            });

            document.getElementById('chat-input').addEventListener('keypress', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });

            // AI回复按钮
            document.getElementById('chat-ai-btn').addEventListener('click', function() {
                triggerAIReply();
            });

            // 自动调整输入框高度
            document.getElementById('chat-input').addEventListener('input', function() {
                this.style.height = 'auto';
                this.style.height = Math.min(this.scrollHeight, 100) + 'px';
            });

            // 个性名片编辑页面
            document.getElementById('card-edit-back-btn').addEventListener('click', function() {
                closeCardEditPage();
            });

            document.getElementById('edit-avatar-btn').addEventListener('click', function() {
                openImagePicker('avatar');
            });

            document.getElementById('edit-bg-btn').addEventListener('click', function() {
                openImagePicker('background');
            });

            document.getElementById('edit-name-btn').addEventListener('click', function() {
                editUserName();
            });

            document.getElementById('edit-signature-btn').addEventListener('click', function() {
                editUserSignature();
            });

            // 图片选择弹窗
            document.getElementById('picker-cancel').addEventListener('click', function() {
                closeImagePicker();
            });

            document.getElementById('picker-local').addEventListener('click', function() {
                document.getElementById('picker-file-input').click();
            });

            document.getElementById('picker-file-input').addEventListener('change', function(e) {
                handleLocalImage(e.target.files[0]);
            });

            document.getElementById('picker-url-toggle').addEventListener('click', function() {
                document.getElementById('picker-url-input').classList.toggle('hidden');
                document.getElementById('picker-url-confirm').classList.toggle('hidden');
            });

            document.getElementById('picker-url-confirm').addEventListener('click', function() {
                handleUrlImage();
            });

            document.getElementById('image-picker-modal').addEventListener('click', function(e) {
                if (e.target === this) {
                    closeImagePicker();
                }
            });

            // 更多功能设置
            document.getElementById('more-func-btn').addEventListener('click', function() {
                openMoreSettings();
            });

            document.getElementById('more-settings-confirm').addEventListener('click', function() {
                closeMoreSettings();
            });

            document.getElementById('more-settings-modal').addEventListener('click', function(e) {
                if (e.target === this) {
                    closeMoreSettings();
                }
            });

            // 功能开关
            document.querySelectorAll('#more-settings-list .toggle-switch').forEach(function(toggle) {
                toggle.addEventListener('click', function() {
                    const funcId = this.dataset.funcId;
                    this.classList.toggle('active');
                    AppState.dynamicFuncs[funcId] = this.classList.contains('active');
                    updateDynamicFuncList();
                    saveToStorage();
                });
            });
        }

        // 渲染UI
        function renderUI() {
            updateUserDisplay();
            renderFriendList();
            renderGroupList();
            renderConversationList();
        }

        // 更新用户显示
        function updateUserDisplay() {
            const user = AppState.user;
            
            // 顶部导航
            const avatarDisplay = document.getElementById('user-avatar-display');
            if (user.avatar) {
                avatarDisplay.innerHTML = `<img src="${user.avatar}" alt="">`;
            } else {
                avatarDisplay.textContent = user.name.charAt(0);
            }
            document.querySelector('.user-name').textContent = user.name;
            
            // 侧边栏名片
            const cardAvatar = document.getElementById('card-avatar');
            if (user.avatar) {
                cardAvatar.innerHTML = `<img src="${user.avatar}" alt="">`;
            } else {
                cardAvatar.textContent = user.name.charAt(0);
            }
            document.getElementById('display-name').textContent = user.name;
            document.getElementById('card-signature').textContent = user.signature;
            
            if (user.bgImage) {
                document.getElementById('card-bg').style.backgroundImage = `url(${user.bgImage})`;
            }
            
            // 编辑页面
            const editPreviewAvatar = document.getElementById('card-edit-preview-avatar');
            if (user.avatar) {
                editPreviewAvatar.innerHTML = `<img src="${user.avatar}" alt="">`;
            } else {
                editPreviewAvatar.textContent = user.name.charAt(0);
            }
            document.getElementById('card-edit-preview-name').textContent = user.name;
            document.getElementById('card-edit-preview-sig').textContent = user.signature;
            
            if (user.bgImage) {
                document.getElementById('card-edit-preview').style.backgroundImage = `url(${user.bgImage})`;
            }
            
            const editAvatarSmall = document.getElementById('edit-avatar-small');
            if (user.avatar) {
                editAvatarSmall.innerHTML = `<img src="${user.avatar}" alt="">`;
            } else {
                editAvatarSmall.textContent = user.name.charAt(0);
                editAvatarSmall.style.display = 'flex';
                editAvatarSmall.style.alignItems = 'center';
                editAvatarSmall.style.justifyContent = 'center';
                editAvatarSmall.style.fontSize = '16px';
                editAvatarSmall.style.color = '#666';
            }
            
            document.getElementById('edit-name-value').textContent = user.name;
            document.getElementById('edit-signature-value').textContent = user.signature;
            document.getElementById('edit-bg-value').textContent = user.bgImage ? '已设置' : '默认';
        }

        // 渲染好友列表
        function renderFriendList() {
            const friendList = document.querySelector('.friend-list[data-group="common"]');
            const count = AppState.friends.length;
            document.querySelector('.group-header[data-group="common"] .group-count').textContent = `(${count}/${count})`;
            
            if (count === 0) {
                friendList.innerHTML = `
                    <div class="empty-state" style="padding: 30px 20px;">
                        <div class="empty-text">暂无好友</div>
                    </div>
                `;
                return;
            }
            
            friendList.innerHTML = AppState.friends.map(function(friend) {
                const avatarContent = friend.avatar 
                    ? `<img src="${friend.avatar}" alt="">`
                    : friend.name.charAt(0);
                return `
                    <div class="friend-item" data-id="${friend.id}" data-type="friend">
                        <div class="friend-avatar">${avatarContent}</div>
                        <div class="friend-info">
                            <div class="friend-name">${friend.name}</div>
                            <div class="friend-desc">${friend.description || '暂无描述'}</div>
                        </div>
                    </div>
                `;
            }).join('');
            
            // 绑定点击事件
            friendList.querySelectorAll('.friend-item').forEach(function(item) {
                item.addEventListener('click', function() {
                    const id = this.dataset.id;
                    const type = this.dataset.type;
                    openChat(id, type);
                });
            });
        }

        // 渲染群聊列表
        function renderGroupList() {
            const groupList = document.querySelector('.friend-list[data-group="groups"]');
            const count = AppState.groups.length;
            document.querySelector('.group-header[data-group="groups"] .group-count').textContent = `(${count}/${count})`;
            
            if (count === 0) {
                groupList.innerHTML = `
                    <div class="empty-state" style="padding: 30px 20px;">
                        <div class="empty-text">暂无群聊</div>
                    </div>
                `;
                return;
            }
            
            groupList.innerHTML = AppState.groups.map(function(group) {
                const avatarContent = group.avatar 
                    ? `<img src="${group.avatar}" alt="">`
                    : group.name.charAt(0);
                return `
                    <div class="friend-item" data-id="${group.id}" data-type="group">
                        <div class="friend-avatar">${avatarContent}</div>
                        <div class="friend-info">
                            <div class="friend-name">${group.name}</div>
                            <div class="friend-desc">${group.description || '暂无描述'}</div>
                        </div>
                    </div>
                `;
            }).join('');
            
            // 绑定点击事件
            groupList.querySelectorAll('.friend-item').forEach(function(item) {
                item.addEventListener('click', function() {
                    const id = this.dataset.id;
                    const type = this.dataset.type;
                    openChat(id, type);
                });
            });
        }

        // 渲染会话列表
        function renderConversationList() {
            const msgList = document.getElementById('msg-list');
            const msgEmpty = document.getElementById('msg-empty');
            
            if (AppState.conversations.length === 0) {
                msgEmpty.style.display = 'flex';
                return;
            }
            
            msgEmpty.style.display = 'none';
            
            // 按最后消息时间排序
            const sorted = [...AppState.conversations].sort(function(a, b) {
                return (b.lastTime || 0) - (a.lastTime || 0);
            });
            
            msgList.innerHTML = sorted.map(function(conv) {
                const avatarContent = conv.avatar 
                    ? `<img src="${conv.avatar}" alt="">`
                    : conv.name.charAt(0);
                const timeStr = conv.lastTime ? formatTime(conv.lastTime) : '';
                return `
                    <div class="msg-item" data-id="${conv.id}" data-type="${conv.type}">
                        <div class="msg-avatar">${avatarContent}</div>
                        <div class="msg-content">
                            <div class="msg-header">
                                <div class="msg-name">${conv.name}</div>
                                <div class="msg-time">${timeStr}</div>
                            </div>
                            <div class="msg-preview">${conv.lastMessage || '暂无消息'}</div>
                        </div>
                    </div>
                `;
            }).join('');
            
            // 绑定点击事件
            msgList.querySelectorAll('.msg-item').forEach(function(item) {
                item.addEventListener('click', function() {
                    const id = this.dataset.id;
                    const type = this.dataset.type;
                    openChat(id, type);
                });
            });
        }

        // 格式化时间
        function formatTime(timestamp) {
            const date = new Date(timestamp);
            const now = new Date();
            const diff = now - date;
            
            if (diff < 60000) return '刚刚';
            if (diff < 3600000) return Math.floor(diff / 60000) + '分钟前';
            if (diff < 86400000) return Math.floor(diff / 3600000) + '小时前';
            if (diff < 604800000) return Math.floor(diff / 86400000) + '天前';
            
            return (date.getMonth() + 1) + '/' + date.getDate();
        }

        // 切换标签页
        function switchTab(tabId) {
            document.querySelectorAll('.tab-item').forEach(function(tab) {
                tab.classList.remove('active');
            });
            document.querySelector(`.tab-item[data-tab="${tabId}"]`).classList.add('active');
            
            document.querySelectorAll('.main-content').forEach(function(page) {
                page.classList.remove('active');
            });
            document.getElementById(tabId).classList.add('active');
            
            AppState.currentTab = tabId;
        }

        // 侧边栏操作
        function closeSideMenu() {
            document.getElementById('side-menu').classList.remove('open');
            document.getElementById('mask').classList.remove('show');
        }

        // 添加弹窗操作
        function toggleAddPopup() {
            document.getElementById('add-popup').classList.toggle('show');
        }

        function closeAddPopup() {
            document.getElementById('add-popup').classList.remove('show');
        }

        // 子页面操作
        function openSubPage(pageId) {
            document.getElementById(pageId).classList.add('open');
        }

        function closeSubPage(pageId) {
            document.getElementById(pageId).classList.remove('open');
        }

        // 菜单点击处理
        function handleMenuClick(func) {
            closeSideMenu();
            
            setTimeout(function() {
                switch(func) {
                    case 'api-settings':
                        openSubPage('api-settings-page');
                        break;
                    case 'chat-summary':
                        openSubPage('chat-summary-page');
                        break;
                    case 'worldbook':
                        openSubPage('worldbook-page');
                        break;
                    case 'settings':
                        alert('设置功能开发中');
                        break;
                    default:
                        alert(func + ' 功能开发中');
                }
            }, 300);
        }

        // 添加好友页面
        function openAddFriendPage() {
            document.getElementById('add-friend-page').classList.add('open');
        }

        function closeAddFriendPage() {
            document.getElementById('add-friend-page').classList.remove('open');
            // 清空输入
            document.getElementById('friend-name-input').value = '';
            document.getElementById('friend-avatar-input').value = '';
            document.getElementById('friend-desc-input').value = '';
            document.getElementById('friend-greeting-input').value = '';
        }

        function addFriend() {
            const name = document.getElementById('friend-name-input').value.trim();
            const avatar = document.getElementById('friend-avatar-input').value.trim();
            const description = document.getElementById('friend-desc-input').value.trim();
            const greeting = document.getElementById('friend-greeting-input').value.trim();
            
            if (!name) {
                alert('请输入好友名称');
                return;
            }
            
            const friend = {
                id: 'friend_' + Date.now(),
                name: name,
                avatar: avatar,
                description: description,
                greeting: greeting,
                createdAt: Date.now()
            };
            
            AppState.friends.push(friend);
            
            // 创建会话
            const conv = {
                id: friend.id,
                type: 'friend',
                name: friend.name,
                avatar: friend.avatar,
                lastMessage: greeting || '已添加为好友',
                lastTime: Date.now()
            };
            AppState.conversations.push(conv);
            
            // 如果有开场白，添加到消息
            if (greeting) {
                AppState.messages[friend.id] = [{
                    id: 'msg_' + Date.now(),
                    type: 'received',
                    content: greeting,
                    time: Date.now()
                }];
            } else {
                AppState.messages[friend.id] = [];
            }
            
            saveToStorage();
            renderUI();
            closeAddFriendPage();
            
            // 切换到消息页
            switchTab('msg-page');
        }

        // 创建群聊页面
        function openCreateGroupPage() {
            document.getElementById('create-group-page').classList.add('open');
        }

        function closeCreateGroupPage() {
            document.getElementById('create-group-page').classList.remove('open');
            document.getElementById('group-name-input').value = '';
            document.getElementById('group-avatar-input').value = '';
            document.getElementById('group-desc-input').value = '';
        }

        function createGroup() {
            const name = document.getElementById('group-name-input').value.trim();
            const avatar = document.getElementById('group-avatar-input').value.trim();
            const description = document.getElementById('group-desc-input').value.trim();
            
            if (!name) {
                alert('请输入群名称');
                return;
            }
            
            const group = {
                id: 'group_' + Date.now(),
                name: name,
                avatar: avatar,
                description: description,
                members: [],
                createdAt: Date.now()
            };
            
            AppState.groups.push(group);
            
            const conv = {
                id: group.id,
                type: 'group',
                name: group.name,
                avatar: group.avatar,
                lastMessage: '群聊已创建',
                lastTime: Date.now()
            };
            AppState.conversations.push(conv);
            AppState.messages[group.id] = [];
            
            saveToStorage();
            renderUI();
            closeCreateGroupPage();
            switchTab('msg-page');
        }

        // 导入角色卡页面
        function openImportCardPage() {
            document.getElementById('import-card-page').classList.add('open');
            AppState.importedCards = [];
            renderImportPreview();
        }

        function closeImportCardPage() {
            document.getElementById('import-card-page').classList.remove('open');
            AppState.importedCards = [];
            document.getElementById('import-file-input').value = '';
            renderImportPreview();
        }

        function handleFileImport(files) {
            Array.from(files).forEach(function(file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const data = JSON.parse(e.target.result);
                        const card = parseCharacterCard(data);
                        if (card) {
                            AppState.importedCards.push(card);
                            renderImportPreview();
                        }
                    } catch (err) {
                        console.error('解析文件失败:', err);
                        alert('文件格式错误: ' + file.name);
                    }
                };
                reader.readAsText(file);
            });
        }

        function parseCharacterCard(data) {
            let card = null;
            
            // SillyTavern V2 格式
            if (data.spec === 'chara_card_v2' && data.data) {
                card = {
                    name: data.data.name,
                    description: data.data.description || data.data.personality || '',
                    greeting: data.data.first_mes || '',
                    avatar: data.data.avatar || '',
                    scenario: data.data.scenario || '',
                    mesExample: data.data.mes_example || ''
                };
            }
            // SillyTavern V1 格式
            else if (data.name) {
                card = {
                    name: data.name,
                    description: data.description || data.personality || '',
                    greeting: data.first_mes || '',
                    avatar: data.avatar || '',
                    scenario: data.scenario || '',
                    mesExample: data.mes_example || ''
                };
            }
            
            if (card && card.name) {
                card.id = 'card_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                return card;
            }
            
            return null;
        }

        function renderImportPreview() {
            const preview = document.getElementById('import-preview');
            const importBtn = document.getElementById('import-all-btn');
            
            if (AppState.importedCards.length === 0) {
                preview.innerHTML = '';
                importBtn.classList.remove('show');
                return;
            }
            
            importBtn.classList.add('show');
            importBtn.textContent = `导入全部角色 (${AppState.importedCards.length})`;
            
            preview.innerHTML = AppState.importedCards.map(function(card, index) {
                const avatarContent = card.avatar 
                    ? `<img src="${card.avatar}" alt="">`
                    : card.name.charAt(0);
                return `
                    <div class="import-preview-item">
                        <div class="import-preview-info">
                            <div class="import-preview-avatar">${avatarContent}</div>
                            <div class="import-preview-name">${card.name}</div>
                        </div>
                        <button class="import-preview-remove" data-index="${index}">×</button>
                    </div>
                `;
            }).join('');
            
            preview.querySelectorAll('.import-preview-remove').forEach(function(btn) {
                btn.addEventListener('click', function() {
                    const index = parseInt(this.dataset.index);
                    AppState.importedCards.splice(index, 1);
                    renderImportPreview();
                });
            });
        }

        function importAllCards() {
            AppState.importedCards.forEach(function(card) {
                const friend = {
                    id: 'friend_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
                    name: card.name,
                    avatar: card.avatar,
                    description: card.description,
                    greeting: card.greeting,
                    scenario: card.scenario,
                    mesExample: card.mesExample,
                    createdAt: Date.now()
                };
                
                AppState.friends.push(friend);
                
                const conv = {
                    id: friend.id,
                    type: 'friend',
                    name: friend.name,
                    avatar: friend.avatar,
                    lastMessage: card.greeting || '已导入角色卡',
                    lastTime: Date.now()
                };
                AppState.conversations.push(conv);
                
                if (card.greeting) {
                    AppState.messages[friend.id] = [{
                        id: 'msg_' + Date.now(),
                        type: 'received',
                        content: card.greeting,
                        time: Date.now()
                    }];
                } else {
                    AppState.messages[friend.id] = [];
                }
            });
            
            saveToStorage();
            renderUI();
            closeImportCardPage();
            switchTab('msg-page');
            
            alert(`成功导入 ${AppState.importedCards.length} 个角色`);
        }

        // 聊天页面
        function openChat(id, type) {
            AppState.currentChat = { id, type };
            
            let target;
            if (type === 'friend') {
                target = AppState.friends.find(function(f) { return f.id === id; });
            } else {
                target = AppState.groups.find(function(g) { return g.id === id; });
            }
            
            if (!target) return;
            
            document.getElementById('chat-title').textContent = target.name;
            renderChatMessages();
            document.getElementById('chat-page').classList.add('open');
            
            // 滚动到底部
            setTimeout(function() {
                const msgContainer = document.getElementById('chat-messages');
                msgContainer.scrollTop = msgContainer.scrollHeight;
            }, 100);
        }

        function closeChatPage() {
            document.getElementById('chat-page').classList.remove('open');
            AppState.currentChat = null;
        }

        function renderChatMessages() {
            const container = document.getElementById('chat-messages');
            const chatId = AppState.currentChat.id;
            const messages = AppState.messages[chatId] || [];
            
            let target;
            if (AppState.currentChat.type === 'friend') {
                target = AppState.friends.find(function(f) { return f.id === chatId; });
            } else {
                target = AppState.groups.find(function(g) { return g.id === chatId; });
            }
            
            if (messages.length === 0) {
                container.innerHTML = `
                    <div style="text-align:center;color:#999;padding:50px 20px;">
                        开始和 ${target ? target.name : 'TA'} 聊天吧
                    </div>
                `;
                return;
            }
            
            container.innerHTML = messages.map(function(msg) {
                if (msg.type === 'sent') {
                    const userAvatar = AppState.user.avatar 
                        ? `<img src="${AppState.user.avatar}" alt="">`
                        : AppState.user.name.charAt(0);
                    return `
                        <div class="chat-bubble sent">
                            <div class="chat-avatar">${userAvatar}</div>
                            <div class="chat-text">${escapeHtml(msg.content)}</div>
                        </div>
                    `;
                } else {
                    const targetAvatar = target && target.avatar 
                        ? `<img src="${target.avatar}" alt="">`
                        : (target ? target.name.charAt(0) : 'AI');
                    return `
                        <div class="chat-bubble received">
                            <div class="chat-avatar">${targetAvatar}</div>
                            <div class="chat-text">${escapeHtml(msg.content)}</div>
                        </div>
                    `;
                }
            }).join('');
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML.replace(/\n/g, '<br>');
        }

        function sendMessage() {
            const input = document.getElementById('chat-input');
            const content = input.value.trim();
            
            if (!content || !AppState.currentChat) return;
            
            const chatId = AppState.currentChat.id;
            
            if (!AppState.messages[chatId]) {
                AppState.messages[chatId] = [];
            }
            
            const msg = {
                id: 'msg_' + Date.now(),
                type: 'sent',
                content: content,
                time: Date.now()
            };
            
            AppState.messages[chatId].push(msg);
            
            // 更新会话
            const conv = AppState.conversations.find(function(c) { return c.id === chatId; });
            if (conv) {
                conv.lastMessage = content;
                conv.lastTime = Date.now();
            }
            
            input.value = '';
            input.style.height = 'auto';
            
            saveToStorage();
            renderChatMessages();
            renderConversationList();
            
            // 滚动到底部
            const msgContainer = document.getElementById('chat-messages');
            msgContainer.scrollTop = msgContainer.scrollHeight;
            
            // 自动触发AI回复
            setTimeout(function() {
                triggerAIReply();
            }, 500);
        }

        // 触发AI回复
        async function triggerAIReply() {
            if (!AppState.currentChat) return;
            
            const chatId = AppState.currentChat.id;
            const messages = AppState.messages[chatId] || [];
            
            let target;
            if (AppState.currentChat.type === 'friend') {
                target = AppState.friends.find(function(f) { return f.id === chatId; });
            } else {
                target = AppState.groups.find(function(g) { return g.id === chatId; });
            }
            
            if (!target) return;
            
            // 检查API设置
            if (!AppState.apiSettings.url || !AppState.apiSettings.key) {
                // 使用模拟回复
                const mockReplies = [
                    '你好呀！很高兴见到你~',
                    '嗯嗯，我在听呢',
                    '这个问题很有趣，让我想想...',
                    '哈哈，你说得对！',
                    '我觉得这样挺好的',
                    '还有什么想聊的吗？'
                ];
                
                setTimeout(function() {
                    const reply = mockReplies[Math.floor(Math.random() * mockReplies.length)];
                    addAIMessage(chatId, reply, target);
                }, 1000);
                return;
            }
            
            // 构建消息历史
            const apiMessages = buildAPIMessages(target, messages);
            
            try {
                const response = await callAPI(apiMessages);
                addAIMessage(chatId, response, target);
            } catch (error) {
                console.error('API调用失败:', error);
                addAIMessage(chatId, '抱歉，我暂时无法回复，请稍后再试。', target);
            }
        }

        function addAIMessage(chatId, content, target) {
            const msg = {
                id: 'msg_' + Date.now(),
                type: 'received',
                content: content,
                time: Date.now()
            };
            
            AppState.messages[chatId].push(msg);
            
            const conv = AppState.conversations.find(function(c) { return c.id === chatId; });
            if (conv) {
                conv.lastMessage = content.substring(0, 50);
                conv.lastTime = Date.now();
            }
            
            saveToStorage();
            renderChatMessages();
            renderConversationList();
            
            const msgContainer = document.getElementById('chat-messages');
            msgContainer.scrollTop = msgContainer.scrollHeight;
        }

        // 构建API消息
        function buildAPIMessages(target, messages) {
            const apiMessages = [];
            
            // 系统提示词
            let systemPrompt = '';
            
            // 时间感知
            if (AppState.apiSettings.timeAware) {
                const timeStr = getCurrentTimeString();
                systemPrompt += `[当前时间: ${timeStr}]\n\n`;
            }
            
            // 角色卡位置处理
            const charPrompt = buildCharacterPrompt(target);
            
            if (AppState.apiSettings.charPosition === 'before') {
                systemPrompt = charPrompt + '\n\n' + AppState.apiSettings.systemPrompt;
            } else if (AppState.apiSettings.charPosition === 'after') {
                systemPrompt = AppState.apiSettings.systemPrompt + '\n\n' + charPrompt;
            } else {
                systemPrompt = charPrompt;
            }
            
            if (systemPrompt.trim()) {
                apiMessages.push({
                    role: 'system',
                    content: systemPrompt.trim()
                });
            }
            
            // 历史消息
            const contextLimit = AppState.apiSettings.contextLimit;
            let tokenCount = 0;
            const recentMessages = [];
            
            for (let i = messages.length - 1; i >= 0; i--) {
                const msg = messages[i];
                const estimatedTokens = msg.content.length / 2;
                
                if (tokenCount + estimatedTokens > contextLimit) break;
                
                recentMessages.unshift({
                    role: msg.type === 'sent' ? 'user' : 'assistant',
                    content: msg.content
                });
                
                tokenCount += estimatedTokens;
            }
            
            apiMessages.push(...recentMessages);
            
            return apiMessages;
        }

        // 构建角色提示词
        function buildCharacterPrompt(target) {
            let prompt = '';
            
            if (target.name) {
                prompt += `你是${target.name}。\n`;
            }
            
            if (target.description) {
                prompt += `\n角色设定：\n${target.description}\n`;
            }
            
            if (target.scenario) {
                prompt += `\n场景：\n${target.scenario}\n`;
            }
            
            if (target.mesExample) {
                prompt += `\n对话示例：\n${target.mesExample}\n`;
            }
            
            return prompt;
        }

        // 获取当前时间字符串
        function getCurrentTimeString() {
            const now = new Date();
            const format = AppState.apiSettings.timeFormat;
            
            const weekDays = ['星期日', '星期一', '星期二', '星期三', '星期四', '星期五', '星期六'];
            
            switch (format) {
                case 'full':
                    return `${now.getFullYear()}年${now.getMonth() + 1}月${now.getDate()}日 ${weekDays[now.getDay()]} ${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}`;
                case 'date':
                    return `${now.getFullYear()}年${now.getMonth() + 1}月${now.getDate()}日`;
                case 'datetime':
                    return `${now.getFullYear()}-${(now.getMonth() + 1).toString().padStart(2, '0')}-${now.getDate().toString().padStart(2, '0')} ${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}`;
                case 'relative':
                    const hour = now.getHours();
                    if (hour < 6) return '凌晨';
                    if (hour < 9) return '早上';
                    if (hour < 12) return '上午';
                    if (hour < 14) return '中午';
                    if (hour < 17) return '下午';
                    if (hour < 19) return '傍晚';
                    return '晚上';
                default:
                    return now.toLocaleString('zh-CN');
            }
        }

        // 调用API
        async function callAPI(messages) {
            const settings = AppState.apiSettings;
            
            const requestBody = {
                model: settings.model,
                messages: messages,
                temperature: settings.temperature,
                top_p: settings.topP,
                max_tokens: settings.maxTokens,
                frequency_penalty: settings.freqPenalty,
                presence_penalty: settings.presPenalty,
                stream: false
            };
            
            const response = await fetch(settings.url + '/chat/completions', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': 'Bearer ' + settings.key
                },
                body: JSON.stringify(requestBody)
            });
            
            if (!response.ok) {
                throw new Error('API请求失败: ' + response.status);
            }
            
            const data = await response.json();
            
            if (data.choices && data.choices[0] && data.choices[0].message) {
                return data.choices[0].message.content;
            }
            
            throw new Error('API响应格式错误');
        }

        // 个性名片编辑
        function openCardEditPage() {
            document.getElementById('card-edit-page').classList.add('open');
            updateUserDisplay();
        }

        function closeCardEditPage() {
            document.getElementById('card-edit-page').classList.remove('open');
        }

        let currentPickerType = '';

        function openImagePicker(type) {
            currentPickerType = type;
            document.getElementById('picker-title').textContent = type === 'avatar' ? '选择头像' : '选择背景图';
            document.getElementById('picker-url-input').classList.add('hidden');
            document.getElementById('picker-url-confirm').classList.add('hidden');
            document.getElementById('picker-url-input').value = '';
            document.getElementById('image-picker-modal').classList.add('show');
        }

        function closeImagePicker() {
            document.getElementById('image-picker-modal').classList.remove('show');
            currentPickerType = '';
        }

        function handleLocalImage(file) {
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                if (currentPickerType === 'avatar') {
                    AppState.user.avatar = e.target.result;
                } else {
                    AppState.user.bgImage = e.target.result;
                }
                saveToStorage();
                updateUserDisplay();
                closeImagePicker();
            };
            reader.readAsDataURL(file);
        }

        function handleUrlImage() {
            const url = document.getElementById('picker-url-input').value.trim();
            if (!url) {
                alert('请输入图片URL');
                return;
            }
            
            if (currentPickerType === 'avatar') {
                AppState.user.avatar = url;
            } else {
                AppState.user.bgImage = url;
            }
            saveToStorage();
            updateUserDisplay();
            closeImagePicker();
        }

        function editUserName() {
            const newName = prompt('请输入新昵称', AppState.user.name);
            if (newName && newName.trim()) {
                AppState.user.name = newName.trim();
                saveToStorage();
                updateUserDisplay();
            }
        }

        function editUserSignature() {
            const newSig = prompt('请输入个性签名', AppState.user.signature);
            if (newSig !== null) {
                AppState.user.signature = newSig.trim() || '这个人很懒，什么都没写~';
                saveToStorage();
                updateUserDisplay();
            }
        }

        // 更多功能设置
        function openMoreSettings() {
            // 同步开关状态
            document.querySelectorAll('#more-settings-list .toggle-switch').forEach(function(toggle) {
                const funcId = toggle.dataset.funcId;
                if (AppState.dynamicFuncs[funcId]) {
                    toggle.classList.add('active');
                } else {
                    toggle.classList.remove('active');
                }
            });
            document.getElementById('more-settings-modal').classList.add('show');
        }

        function closeMoreSettings() {
            document.getElementById('more-settings-modal').classList.remove('show');
        }

        function updateDynamicFuncList() {
            document.querySelectorAll('.func-row[data-func-id]').forEach(function(row) {
                const funcId = row.dataset.funcId;
                if (AppState.dynamicFuncs[funcId]) {
                    row.style.display = 'flex';
                } else {
                    row.style.display = 'none';
                }
            });
        }

        // API设置初始化
        function initAPISettings() {
            const settings = AppState.apiSettings;
            
            document.getElementById('api-type').value = settings.type;
            document.getElementById('api-url').value = settings.url;
            document.getElementById('api-key').value = settings.key;
            document.getElementById('api-model').value = settings.model;
            
            document.getElementById('api-temperature').value = settings.temperature * 100;
            document.getElementById('api-temperature-value').textContent = settings.temperature;
            
            document.getElementById('api-top-p').value = settings.topP * 100;
            document.getElementById('api-top-p-value').textContent = settings.topP;
            
            document.getElementById('api-max-tokens').value = settings.maxTokens;
            document.getElementById('api-max-tokens-value').textContent = settings.maxTokens;
            
            document.getElementById('api-freq-penalty').value = settings.freqPenalty * 100;
            document.getElementById('api-freq-penalty-value').textContent = settings.freqPenalty;
            
            document.getElementById('api-pres-penalty').value = settings.presPenalty * 100;
            document.getElementById('api-pres-penalty-value').textContent = settings.presPenalty;
            
            if (settings.timeAware) {
                document.getElementById('api-time-aware').classList.add('active');
            }
            document.getElementById('api-time-format').value = settings.timeFormat;
            
            document.getElementById('api-system-prompt').value = settings.systemPrompt;
            document.getElementById('api-char-position').value = settings.charPosition;
            
            if (settings.streaming) {
                document.getElementById('api-streaming').classList.add('active');
            }
            if (settings.autoRetry) {
                document.getElementById('api-auto-retry').classList.add('active');
            }
            
            document.getElementById('api-context-limit').value = settings.contextLimit;
            document.getElementById('api-context-limit-value').textContent = (settings.contextLimit / 1000) + 'K';
            
            updateAPIStatus();
            
            // 绑定事件
            document.getElementById('api-temperature').addEventListener('input', function() {
                const val = (this.value / 100).toFixed(2);
                document.getElementById('api-temperature-value').textContent = val;
            });
            
            document.getElementById('api-top-p').addEventListener('input', function() {
                const val = (this.value / 100).toFixed(2);
                document.getElementById('api-top-p-value').textContent = val;
            });
            
            document.getElementById('api-max-tokens').addEventListener('input', function() {
                document.getElementById('api-max-tokens-value').textContent = this.value;
            });
            
            document.getElementById('api-freq-penalty').addEventListener('input', function() {
                const val = (this.value / 100).toFixed(2);
                document.getElementById('api-freq-penalty-value').textContent = val;
            });
            
            document.getElementById('api-pres-penalty').addEventListener('input', function() {
                const val = (this.value / 100).toFixed(2);
                document.getElementById('api-pres-penalty-value').textContent = val;
            });
            
            document.getElementById('api-context-limit').addEventListener('input', function() {
                document.getElementById('api-context-limit-value').textContent = (this.value / 1000).toFixed(0) + 'K';
            });
            
            document.getElementById('api-time-aware').addEventListener('click', function() {
                this.classList.toggle('active');
            });
            
            document.getElementById('api-streaming').addEventListener('click', function() {
                this.classList.toggle('active');
            });
            
            document.getElementById('api-auto-retry').addEventListener('click', function() {
                this.classList.toggle('active');
            });
            
            document.getElementById('api-test-btn').addEventListener('click', testAPIConnection);
            document.getElementById('api-save-btn').addEventListener('click', saveAPISettings);
        }

        function updateAPIStatus() {
            const dot = document.getElementById('api-status-dot');
            const text = document.getElementById('api-status-text');
            
            if (AppState.apiSettings.connected) {
                dot.classList.add('connected');
                text.textContent = '已连接';
            } else {
                dot.classList.remove('connected');
                text.textContent = '未连接';
            }
        }

        async function testAPIConnection() {
            const btn = document.getElementById('api-test-btn');
            btn.textContent = '测试中...';
            btn.disabled = true;
            
            const url = document.getElementById('api-url').value.trim();
            const key = document.getElementById('api-key').value.trim();
            const model = document.getElementById('api-model').value.trim();
            
            if (!url || !key) {
                alert('请填写API地址和密钥');
                btn.textContent = '测试连接';
                btn.disabled = false;
                return;
            }
            
            try {
                const response = await fetch(url + '/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + key
                    },
                    body: JSON.stringify({
                        model: model || 'gpt-4o-mini',
                        messages: [{ role: 'user', content: 'Hi' }],
                        max_tokens: 5
                    })
                });
                
                if (response.ok) {
                    AppState.apiSettings.connected = true;
                    updateAPIStatus();
                    alert('连接成功！');
                } else {
                    const error = await response.text();
                    throw new Error(error);
                }
            } catch (error) {
                AppState.apiSettings.connected = false;
                updateAPIStatus();
                alert('连接失败: ' + error.message);
            }
            
            btn.textContent = '测试连接';
            btn.disabled = false;
        }

        function saveAPISettings() {
            AppState.apiSettings.type = document.getElementById('api-type').value;
            AppState.apiSettings.url = document.getElementById('api-url').value.trim();
            AppState.apiSettings.key = document.getElementById('api-key').value.trim();
            AppState.apiSettings.model = document.getElementById('api-model').value.trim();
            
            AppState.apiSettings.temperature = parseFloat(document.getElementById('api-temperature').value) / 100;
            AppState.apiSettings.topP = parseFloat(document.getElementById('api-top-p').value) / 100;
            AppState.apiSettings.maxTokens = parseInt(document.getElementById('api-max-tokens').value);
            AppState.apiSettings.freqPenalty = parseFloat(document.getElementById('api-freq-penalty').value) / 100;
            AppState.apiSettings.presPenalty = parseFloat(document.getElementById('api-pres-penalty').value) / 100;
            
            AppState.apiSettings.timeAware = document.getElementById('api-time-aware').classList.contains('active');
            AppState.apiSettings.timeFormat = document.getElementById('api-time-format').value;
            
            AppState.apiSettings.systemPrompt = document.getElementById('api-system-prompt').value;
            AppState.apiSettings.charPosition = document.getElementById('api-char-position').value;
            
            AppState.apiSettings.streaming = document.getElementById('api-streaming').classList.contains('active');
            AppState.apiSettings.autoRetry = document.getElementById('api-auto-retry').classList.contains('active');
            AppState.apiSettings.contextLimit = parseInt(document.getElementById('api-context-limit').value);
            
            saveToStorage();
            alert('设置已保存');
        }
    </script>
</body>
</html>
